---
title: Verwenden der EVENTDATA-Funktion | Microsoft-Dokumentation
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- EVENTDATA function
- DDL triggers, EVENTDATA function
ms.assetid: 675b8320-9c73-4526-bd2f-91ba42c1b604
author: rothja
ms.author: jroth
ms.openlocfilehash: 57fb59a3954fb00ab943944c58cccd352c7270d2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/04/2020
ms.locfileid: "87621915"
---
# <a name="use-the-eventdata-function"></a><span data-ttu-id="79645-102">Verwenden der EVENTDATA-Funktion</span><span class="sxs-lookup"><span data-stu-id="79645-102">Use the EVENTDATA Function</span></span>
  <span data-ttu-id="79645-103">Informationen zu einem Ereignis, das einen DDL-Trigger auslöst, werden mit der EVENTDATA-Funktion erfasst.</span><span class="sxs-lookup"><span data-stu-id="79645-103">Information about an event that fires a DDL trigger is captured by using the EVENTDATA function.</span></span> <span data-ttu-id="79645-104">Diese Funktion gibt einen `xml`-Wert zurück.</span><span class="sxs-lookup"><span data-stu-id="79645-104">This function returns an `xml` value.</span></span> <span data-ttu-id="79645-105">Das XML-Schema schließt Informationen zu folgenden Punkten ein:</span><span class="sxs-lookup"><span data-stu-id="79645-105">The XML schema includes information about the following:</span></span>  
  
-   <span data-ttu-id="79645-106">Zeitpunkt des Ereignisses.</span><span class="sxs-lookup"><span data-stu-id="79645-106">The time of the event.</span></span>  
  
-   <span data-ttu-id="79645-107">Die SPID (System Process ID) der Verbindung, als der Trigger ausgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="79645-107">The System Process ID (SPID) of the connection when the trigger executed.</span></span>  
  
-   <span data-ttu-id="79645-108">Der Typ des Ereignisses, die den Trigger ausgelöst haben.</span><span class="sxs-lookup"><span data-stu-id="79645-108">The type of event that fired the trigger.</span></span>  
  
 <span data-ttu-id="79645-109">Abhängig vom Ereignistyp schließt das Schema dann weitere Informationen ein, z. B. die Datenbank, in der das Ereignis aufgetreten ist, das Objekt, für das das Ereignis erfolgte, und die [!INCLUDE[tsql](../../includes/tsql-md.md)] -Anweisung des Ereignisses.</span><span class="sxs-lookup"><span data-stu-id="79645-109">Depending on the event type, the schema then includes additional information such as the database in which the event occurred, the object against which the event occurred, and the [!INCLUDE[tsql](../../includes/tsql-md.md)] statement of the event.</span></span> <span data-ttu-id="79645-110">Weitere Informationen finden Sie unter [DDL Triggers](ddl-triggers.md).</span><span class="sxs-lookup"><span data-stu-id="79645-110">For more information, see [DDL Triggers](ddl-triggers.md).</span></span>  
  
 <span data-ttu-id="79645-111">Der folgende DDL-Trigger wird z. B. in der [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] -Beispieldatenbank erstellt:</span><span class="sxs-lookup"><span data-stu-id="79645-111">For example, the following DDL trigger is created in the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database:</span></span>  
  
```  
CREATE TRIGGER safety   
ON DATABASE   
FOR CREATE_TABLE   
AS   
    PRINT 'CREATE TABLE Issued.'  
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)')  
   RAISERROR ('New tables cannot be created in this database.', 16, 1)   
   ROLLBACK  
;  
```  
  
 <span data-ttu-id="79645-112">Anschließend wird die folgende `CREATE TABLE` -Anweisung ausgeführt:</span><span class="sxs-lookup"><span data-stu-id="79645-112">The following `CREATE TABLE` statement is then run:</span></span>  
  
 `CREATE TABLE NewTable (Column1 int);`  
  
 <span data-ttu-id="79645-113">Die `EVENTDATA()` -Anweisung im DDL-Trigger erfasst den Text der `CREATE TABLE` -Anweisung, die nicht zulässig ist.</span><span class="sxs-lookup"><span data-stu-id="79645-113">The `EVENTDATA()` statement in the DDL trigger captures the text of the `CREATE TABLE` statement that is not allowed.</span></span> <span data-ttu-id="79645-114">Dies wird erreicht, indem eine XQuery-Anweisung für die `xml` Daten verwendet wird, die von EVENTDATA generiert werden, und das-Element abgerufen wird \<CommandText> .</span><span class="sxs-lookup"><span data-stu-id="79645-114">This is achieved by using an XQuery statement against the `xml` data that is generated by EVENTDATA and retrieving the \<CommandText> element.</span></span> <span data-ttu-id="79645-115">Weitere Informationen finden Sie unter [XQuery-Sprachreferenz &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span><span class="sxs-lookup"><span data-stu-id="79645-115">For more information, see [XQuery Language Reference &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="79645-116">EVENTDATA erfasst die Daten von CREATE_SCHEMA-Ereignissen sowie den <schema_element>-Text der entsprechenden CREATE SCHEMA-Definition, sofern vorhanden.</span><span class="sxs-lookup"><span data-stu-id="79645-116">EVENTDATA captures the data of CREATE_SCHEMA events as well as the <schema_element> of the corresponding CREATE SCHEMA definition, if any exists.</span></span> <span data-ttu-id="79645-117">Darüber hinaus erkennt EVENTDATA die <schema_element>-Definition als ein gesondertes Ereignis.</span><span class="sxs-lookup"><span data-stu-id="79645-117">Additionally, EVENTDATA recognizes the <schema_element> definition as a separate event.</span></span> <span data-ttu-id="79645-118">Deshalb ist es möglich, dass ein DDL-Trigger erstellt wurde, der für ein CREATE_SCHEMA-Ereignis sowie für ein Ereignis, das durch den <schema_element>-Text der CREATE SCHEMA-Definition dargestellt wird, möglicherweise dieselben Ereignisdaten doppelt zurückgibt, wie z. B. die `TSQLCommand`-Daten.</span><span class="sxs-lookup"><span data-stu-id="79645-118">Therefore, a DDL trigger created on both a CREATE_SCHEMA event, and an event represented by the <schema_element> of the CREATE SCHEMA definition, may return the same event data twice, such as the `TSQLCommand` data.</span></span> <span data-ttu-id="79645-119">Angenommen, ein DDL-Trigger wird für die Ereignisse CREATE_SCHEMA und CREATE_TABLE erstellt, und der folgende Batch wird ausgeführt:</span><span class="sxs-lookup"><span data-stu-id="79645-119">For example, consider a DDL trigger that is created on both the CREATE_SCHEMA and CREATE_TABLE events and the following batch is run:</span></span>  
>   
>  `CREATE SCHEMA s`  
>   
>  `CREATE TABLE t1 (col1 int)`  
>   
>  <span data-ttu-id="79645-120">Ruft die Anwendung die `TSQLCommand` -Daten des CREATE_TABLE-Ereignisses ab, sollten Sie beachten, dass diese Daten möglicherweise doppelt angezeigt werden: einmal, wenn das CREATE_SCHEMA-Ereignis stattfindet, und ein zweites Mal, wenn das CREATE_TABLE-Ereignis stattfindet.</span><span class="sxs-lookup"><span data-stu-id="79645-120">If the application retrieves the `TSQLCommand` data of the CREATE_TABLE event, be aware that this data may appear two times: once when the CREATE_SCHEMA event occurs, and again when the CREATE_TABLE event occurs.</span></span> <span data-ttu-id="79645-121">Vermeiden Sie das Erstellen von DDL-Triggern sowohl für die CREATE_SCHEMA-Ereignisse als auch für die <schema_element>-Texte entsprechender CREATE SCHEMA-Definitionen, oder integrieren Sie eine Logik in die Anwendung, damit dasselbe Ereignis nicht doppelt verarbeitet wird.</span><span class="sxs-lookup"><span data-stu-id="79645-121">Avoid creating DDL triggers on both the CREATE_SCHEMA events and the <schema_element> texts of any corresponding CREATE SCHEMA definitions, or build logic into your application so that the same event is not processed twice.</span></span>  
  
## <a name="alter-table-and-alter-database-events"></a><span data-ttu-id="79645-122">ALTER TABLE-Ereignis und ALTER DATABASE-Ereignis</span><span class="sxs-lookup"><span data-stu-id="79645-122">ALTER TABLE and ALTER DATABASE Events</span></span>  
 <span data-ttu-id="79645-123">Die Ereignisdaten für das ALTER_TABLE-Ereignis und das ALTER DATABASE-Ereignis umfassen auch die Namen und Typen anderer Objekte, die durch die DDL-Anweisung betroffen sind, sowie die Aktionen, die für diese Objekte ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="79645-123">The event data for the ALTER_TABLE and ALTER_DATABASE events also includes the names and types of other objects affected by the DDL statement and the action performed on these objects.</span></span> <span data-ttu-id="79645-124">Die Daten für das ALTER_TABLE-Ereignis umfassen die Namen der Spalten, Einschränkungen oder Trigger, die durch die ALTER TABLE-Anweisung betroffen sind, sowie die Aktion (Erstellen, Ändern, Löschen, Aktivieren oder Deaktivieren), die für die betroffenen Objekte ausgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="79645-124">The ALTER_TABLE event data includes the names of the columns, constraints, or triggers affected by the ALTER TABLE statement and the action (create, alter, drop, enable, or disable) performed on the affected objects.</span></span> <span data-ttu-id="79645-125">Die Daten für das ALTER_DATABASE-Ereignis umfassen die Namen aller Dateien oder Dateigruppen, die durch die ALTER_DATABASE-Anweisung betroffen sind, sowie die Aktion (Erstellen, Ändern oder Löschen), die für die betroffenen Objekte ausgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="79645-125">The ALTER_DATABASE event data includes the names of any files or filegroups affected by the ALTER DATABASE statement and the action (create, alter, or drop) performed on the affected objects.</span></span>  
  
 <span data-ttu-id="79645-126">Der folgende DDL-Trigger wird beispielsweise in der AdventureWorks-Beispieldatenbank erstellt:</span><span class="sxs-lookup"><span data-stu-id="79645-126">For example, create the following DDL trigger in the AdventureWorks sample database:</span></span>  
  
```  
CREATE TRIGGER ColumnChanges  
ON DATABASE   
FOR ALTER_TABLE  
AS  
-- Detect whether a column was created/altered/dropped.  
SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'nvarchar(max)')  
RAISERROR ('Table schema cannot be modified in this database.', 16, 1);  
ROLLBACK;  
```  
  
 <span data-ttu-id="79645-127">Führen Sie dann die folgende ALTER TABLE-Anweisung aus, die gegen eine Einschränkung verstößt:</span><span class="sxs-lookup"><span data-stu-id="79645-127">Then execute the following ALTER TABLE statement that violates a constraint:</span></span>  
  
```  
ALTER TABLE Person.Address ALTER COLUMN ModifiedDate date;   
```  
  
 <span data-ttu-id="79645-128">Die EVENTDATA()-Anweisung im DDL-Trigger erfasst den Text der `ALTER TABLE` -Anweisung, der nicht zulässig ist.</span><span class="sxs-lookup"><span data-stu-id="79645-128">The EVENTDATA() statement in the DDL trigger captures the text of the `ALTER TABLE` statement that is not permitted.</span></span>  
  
## <a name="example"></a><span data-ttu-id="79645-129">Beispiel</span><span class="sxs-lookup"><span data-stu-id="79645-129">Example</span></span>  
 <span data-ttu-id="79645-130">Mithilfe der EVENTDATA-Funktion können Sie ein Ereignisprotokoll erstellen.</span><span class="sxs-lookup"><span data-stu-id="79645-130">You can use the EVENTDATA function to create a log of events.</span></span> <span data-ttu-id="79645-131">Im folgenden Beispiel wird eine Tabelle zum Speichern von Ereignisinformationen erstellt.</span><span class="sxs-lookup"><span data-stu-id="79645-131">In the following example, a table is created to store event information.</span></span> <span data-ttu-id="79645-132">Anschließend wird ein DDL-Trigger für die aktuelle Datenbank erstellt, die bei jedem Auftreten eines DDL-Ereignisses auf Datenbankebene die Tabelle mit den folgenden Informationen auffüllt:</span><span class="sxs-lookup"><span data-stu-id="79645-132">A DDL trigger is then created on the current database that populates the table with the following information whenever any database-level DDL event occurs:</span></span>  
  
-   <span data-ttu-id="79645-133">Zeitpunkt des Ereignisses (mithilfe der GETDATE-Funktion)</span><span class="sxs-lookup"><span data-stu-id="79645-133">The time of the event (using the GETDATE function).</span></span>  
  
-   <span data-ttu-id="79645-134">Datenbankbenutzer, für dessen Sitzung das Ereignis aufgetreten ist (mithilfe der CURRENT_USER-Funktion)</span><span class="sxs-lookup"><span data-stu-id="79645-134">The database user against whose session the event occurred (using the CURRENT_USER function).</span></span>  
  
-   <span data-ttu-id="79645-135">Typ des Ereignisses</span><span class="sxs-lookup"><span data-stu-id="79645-135">The type of the event.</span></span>  
  
-   <span data-ttu-id="79645-136">Die [!INCLUDE[tsql](../../includes/tsql-md.md)] -Anweisung, die das Ereignis enthalten hat.</span><span class="sxs-lookup"><span data-stu-id="79645-136">The [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that comprised the event.</span></span>  
  
 <span data-ttu-id="79645-137">Die beiden letzten Elemente werden wiederum erfasst, indem XQuery für die von EVENTDATA generierten `xml`-Daten verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="79645-137">Again, the last two items are captured by using XQuery against the `xml` data that is generated by EVENTDATA.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE TABLE ddl_log (PostTime datetime, DB_User nvarchar(100), Event nvarchar(100), TSQL nvarchar(2000));  
GO  
CREATE TRIGGER log   
ON DATABASE   
FOR DDL_DATABASE_LEVEL_EVENTS   
AS  
DECLARE @data XML  
SET @data = EVENTDATA()  
INSERT ddl_log   
   (PostTime, DB_User, Event, TSQL)   
   VALUES   
   (GETDATE(),   
   CONVERT(nvarchar(100), CURRENT_USER),   
   @data.value('(/EVENT_INSTANCE/EventType)[1]', 'nvarchar(100)'),   
   @data.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'nvarchar(2000)') ) ;  
GO  
--Test the trigger  
CREATE TABLE TestTable (a int)  
DROP TABLE TestTable ;  
GO  
SELECT * FROM ddl_log ;  
GO  
```  
  
> [!NOTE]  
>  <span data-ttu-id="79645-138">Zur Rückgabe von Ereignisdaten sollten Sie die XQuery-`value()`-Methode anstelle der `query()`-Methode verwenden.</span><span class="sxs-lookup"><span data-stu-id="79645-138">To return event data, we recommend that you use the XQuery `value()` method instead of the `query()` method.</span></span> <span data-ttu-id="79645-139">Die `query()`-Methode gibt in der Ausgabe XML und Ampersand-Escape-CRLF-Instanzen (Carriage Return and Line Feed) zurück, wogegen die `value()`-Methode CRLF-Instanzen zurückgibt, die in der Ausgabe unsichtbar sind.</span><span class="sxs-lookup"><span data-stu-id="79645-139">The `query()` method returns XML and ampersand-escaped carriage return and line-feed (CRLF) instances in the output, while the `value()` method renders CRLF instances invisible in the output.</span></span>  
  
 <span data-ttu-id="79645-140">Ein ähnliches Beispiel für einen DDL-Trigger wird mit der [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] -Beispieldatenbank bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="79645-140">A similar DDL trigger example is provided with the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database.</span></span> <span data-ttu-id="79645-141">Auf das Beispiel können Sie mithilfe von [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]im Ordner "Datenbanktrigger" zugreifen.</span><span class="sxs-lookup"><span data-stu-id="79645-141">To obtain the example, locate the Database Triggers folder by using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="79645-142">Dieser Ordner befindet sich unter dem Ordner **Programmierbarkeit** der [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] -Datenbank.</span><span class="sxs-lookup"><span data-stu-id="79645-142">This folder is located under the **Programmability** folder of the [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] database.</span></span> <span data-ttu-id="79645-143">Klicken Sie mit der rechten Maustaste auf **ddlDatabaseTriggerLog**, und wählen Sie **Skript für Datenbanktrigger als** aus.</span><span class="sxs-lookup"><span data-stu-id="79645-143">Right-click **ddlDatabaseTriggerLog** and select **Script Database Trigger as**.</span></span> <span data-ttu-id="79645-144">Standardmäßig ist der DDL-Trigger **ddlDatabaseTriggerLog** deaktiviert.</span><span class="sxs-lookup"><span data-stu-id="79645-144">By default, DDL trigger **ddlDatabaseTriggerLog** is disabled.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="79645-145">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="79645-145">See Also</span></span>  
 <span data-ttu-id="79645-146">[DDL-Ereignisse](../triggers/ddl-events.md) </span><span class="sxs-lookup"><span data-stu-id="79645-146">[DDL Events](../triggers/ddl-events.md) </span></span>  
 [<span data-ttu-id="79645-147">DDL-Ereignisgruppen</span><span class="sxs-lookup"><span data-stu-id="79645-147">DDL Event Groups</span></span>](../triggers/ddl-event-groups.md)  
  
  
