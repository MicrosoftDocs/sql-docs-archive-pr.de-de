---
title: Statistik | Microsoft-Dokumentation
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- statistical information [SQL Server], query optimization
- query performance [SQL Server], statistics
- query optimization statistics [SQL Server]
- statistical information [SQL Server], database options
- query optimization statistics [SQL Server], about query optimization statistics
- statistical information [SQL Server], guidelines
- statistical information [SQL Server]
- using statistics [SQL Server]
- statistical information [SQL Server], indexes
- index statistics [SQL Server]
- query optimizer [SQL Server], statistics
- statistics [SQL Server]
ms.assetid: b86a88ba-4f7c-4e19-9fbd-2f8bcd3be14a
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0f0950e48245bed53581d2f91b120ab9555aa562
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/04/2020
ms.locfileid: "87621411"
---
# <a name="statistics"></a><span data-ttu-id="bd764-102">Statistik</span><span class="sxs-lookup"><span data-stu-id="bd764-102">Statistics</span></span>
  <span data-ttu-id="bd764-103">Der Abfrageoptimierer verwendet Statistiken zum Erstellen von Abfrageplänen, die die Abfrageleistung verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-103">The query optimizer uses statistics to create query plans that improve query performance.</span></span> <span data-ttu-id="bd764-104">Bei den meisten Abfragen generiert der Abfrageoptimierer automatisch die notwendigen Statistiken für einen hochwertigen Abfrageplan. In einigen Fällen müssen Sie weitere Statistiken erstellen oder den Abfrageentwurf ändern, um optimale Ergebnisse zu erzielen.</span><span class="sxs-lookup"><span data-stu-id="bd764-104">For most queries, the query optimizer already generates the necessary statistics for a high quality query plan; in a few cases, you need to create additional statistics or modify the query design for best results.</span></span> <span data-ttu-id="bd764-105">Dieses Thema enthält eine Erläuterung von Statistikkonzepten sowie Richtlinien zur effektiven Verwendung von Abfrageoptimierungsstatistiken.</span><span class="sxs-lookup"><span data-stu-id="bd764-105">This topic discusses statistics concepts and provides guidelines for using query optimization statistics effectively.</span></span>  
  
##  <a name="components-and-concepts"></a><a name="DefinitionQOStatistics"></a> <span data-ttu-id="bd764-106">Komponenten und Konzepte</span><span class="sxs-lookup"><span data-stu-id="bd764-106">Components and Concepts</span></span>  
 <span data-ttu-id="bd764-107">Statistik</span><span class="sxs-lookup"><span data-stu-id="bd764-107">Statistics</span></span>  
 <span data-ttu-id="bd764-108">Statistiken zur Abfrageoptimierung sind Objekte, die statistische Informationen über die Verteilung von Werten in Spalten einer Tabelle oder indizierten Sicht enthalten.</span><span class="sxs-lookup"><span data-stu-id="bd764-108">Statistics for query optimization are objects that contain statistical information about the distribution of values in one or more columns of a table or indexed view.</span></span> <span data-ttu-id="bd764-109">Der Abfrageoptimierer verwendet diese Statistiken, um die *Kardinalität*oder Anzahl von Zeilen im Abfrageergebnis zu schätzen.</span><span class="sxs-lookup"><span data-stu-id="bd764-109">The query optimizer uses these statistics to estimate the *cardinality*, or number of rows, in the query result.</span></span> <span data-ttu-id="bd764-110">Diese *Kardinalitätsschätzungen* ermöglichen es dem Abfrageoptimierer, einen hochwertigen Abfrageplan zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="bd764-110">These *cardinality estimates* enable the query optimizer to create a high-quality query plan.</span></span> <span data-ttu-id="bd764-111">Beispielsweise kann der Abfrageoptimierer Kardinalitätsschätzungen verwenden, um statt des ressourcenintensiveren Index Scan-Operators den Index Seek-Operator auszuwählen und so die Abfrageleistung zu verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-111">For example, the query optimizer could use cardinality estimates to choose the index seek operator instead of the more resource-intensive index scan operator, and in doing so improve query performance.</span></span>  
  
 <span data-ttu-id="bd764-112">Jedes Statistikobjekt wird für eine Liste mit mindestens einer Tabellenspalte erstellt und enthält ein Histogramm, das die Verteilung von Werten in der ersten Spalte anzeigt.</span><span class="sxs-lookup"><span data-stu-id="bd764-112">Each statistics object is created on a list of one or more table columns and includes a histogram displaying the distribution of values in the first column.</span></span> <span data-ttu-id="bd764-113">Statistikobjekte, die sich auf mehrere Spalten beziehen, enthalten außerdem statistische Informationen über die spaltenübergreifende Korrelation von Werten.</span><span class="sxs-lookup"><span data-stu-id="bd764-113">Statistics objects on multiple columns also store statistical information about the correlation of values among the columns.</span></span> <span data-ttu-id="bd764-114">Diese Korrelationsstatistiken oder *Dichten*werden von der Anzahl unterschiedlicher Zeilen mit Spaltenwerten abgeleitet.</span><span class="sxs-lookup"><span data-stu-id="bd764-114">These correlation statistics, or *densities*, are derived from the number of distinct rows of column values.</span></span> <span data-ttu-id="bd764-115">Weitere Informationen zu Statistikobjekten finden Sie unter [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-115">For more information about statistics objects, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="bd764-116">Gefilterte Statistiken</span><span class="sxs-lookup"><span data-stu-id="bd764-116">Filtered Statistics</span></span>  
 <span data-ttu-id="bd764-117">Gefilterte Statistiken können die Abfrageleistung für Abfragen verbessern, bei denen aus klar definierten Teilmengen von Daten ausgewählt wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-117">Filtered statistics can improve query performance for queries that select from well-defined subsets of data.</span></span> <span data-ttu-id="bd764-118">Gefilterte Statistiken verwenden ein Filterprädikat, um die Teilmenge von Daten auszuwählen, die in der Statistik enthalten ist.</span><span class="sxs-lookup"><span data-stu-id="bd764-118">Filtered statistics use a filter predicate to select the subset of data that is included in the statistics.</span></span> <span data-ttu-id="bd764-119">Sorgfältig entworfene gefilterte Statistiken können den Abfrageausführungsplan im Vergleich zu Tabellenstatistiken verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-119">Well-designed filtered statistics can improve the query execution plan compared with full-table statistics.</span></span> <span data-ttu-id="bd764-120">Weitere Informationen zum Filterprädikat finden Sie unter [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-120">For more information about the filter predicate, see [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span></span> <span data-ttu-id="bd764-121">Weitere Informationen zum Zeitpunkt der Erstellung von gefilterten Statistiken finden Sie im Abschnitt [Zeitpunkt der Erstellung von Statistiken](#UpdateStatistics) in diesem Thema.</span><span class="sxs-lookup"><span data-stu-id="bd764-121">For more information about when to create filtered statistics, see the [When to Create Statistics](#UpdateStatistics) section in this topic.</span></span> <span data-ttu-id="bd764-122">Eine Fallstudie finden Sie im Blogbeitrag [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505)(Verwenden von gefilterten Statistiken mit partitionierten Tabellen) auf der SQLCAT-Website.</span><span class="sxs-lookup"><span data-stu-id="bd764-122">For a case study, see the blog entry, [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505), on the SQLCAT Web site.</span></span>  
  
 <span data-ttu-id="bd764-123">Statistikoptionen</span><span class="sxs-lookup"><span data-stu-id="bd764-123">Statistics Options</span></span>  
 <span data-ttu-id="bd764-124">Anhand von drei Optionen können Sie festlegen, wann und wie Statistiken erstellt und aktualisiert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-124">There are three options that you can set that affect when and how statistics are created and updated.</span></span> <span data-ttu-id="bd764-125">Diese Optionen werden nur auf Datenbankebene festgelegt.</span><span class="sxs-lookup"><span data-stu-id="bd764-125">These options are set at the database level only.</span></span>  
  
 <span data-ttu-id="bd764-126">AUTO_CREATE_STATISTICS (Option)</span><span class="sxs-lookup"><span data-stu-id="bd764-126">AUTO_CREATE_STATISTICS Option</span></span>  
 <span data-ttu-id="bd764-127">Ist die AUTO_CREATE_STATISTICS-Option zum automatischen Erstellen von Statistiken aktiviert, erstellt der Abfrageoptimierer nach Bedarf Statistiken für einzelne Spalten im Abfrageprädikat, um Kardinalitätsschätzungen für den Abfrageplan zu verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-127">When the automatic create statistics option, AUTO_CREATE_STATISTICS, is on, the query optimizer creates statistics on individual columns in the query predicate, as necessary, to improve cardinality estimates for the query plan.</span></span> <span data-ttu-id="bd764-128">Diese Statistiken für einzelne Spalten werden für Spalten erstellt, die noch nicht über ein Histogramm in einem vorhandenen Statistikobjekt verfügen.</span><span class="sxs-lookup"><span data-stu-id="bd764-128">These single-column statistics are created on columns that do not already have a histogram in an existing statistics object.</span></span> <span data-ttu-id="bd764-129">Durch die AUTO_CREATE_STATISTICS-Option wird nicht festgelegt, ob Statistiken für Indizes erstellt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-129">The AUTO_CREATE_STATISTICS option does not determine whether statistics get created for indexes.</span></span> <span data-ttu-id="bd764-130">Durch diese Option werden auch keine gefilterten Statistiken generiert.</span><span class="sxs-lookup"><span data-stu-id="bd764-130">This option also does not generate filtered statistics.</span></span> <span data-ttu-id="bd764-131">Sie gilt ausschließlich für Statistiken für einzelne Spalten der gesamten Tabelle.</span><span class="sxs-lookup"><span data-stu-id="bd764-131">It applies strictly to single-column statistics for the full table.</span></span>  
  
 <span data-ttu-id="bd764-132">Erstellt der Abfrageoptimierer Statistiken als Ergebnis der Verwendung der AUTO_CREATE_STATISTICS-Option, beginnt der Statistikname mit `_WA`.</span><span class="sxs-lookup"><span data-stu-id="bd764-132">When the query optimizer creates statistics as a result of using the AUTO_CREATE_STATISTICS option, the statistics name starts with `_WA`.</span></span> <span data-ttu-id="bd764-133">Mithilfe der folgenden Abfrage können Sie bestimmen, ob der Abfrageoptimierer Statistiken für eine Abfrageprädikatsspalte erstellt hat.</span><span class="sxs-lookup"><span data-stu-id="bd764-133">You can use the following query to determine if the query optimizer has created statistics for a query predicate column.</span></span>  
  
```  
SELECT OBJECT_NAME(s.object_id) AS object_name,  
    COL_NAME(sc.object_id, sc.column_id) AS column_name,  
    s.name AS statistics_name  
FROM sys.stats AS s JOIN sys.stats_columns AS sc  
    ON s.stats_id = sc.stats_id AND s.object_id = sc.object_id  
WHERE s.name like '_WA%'  
ORDER BY s.name;  
```  
  
 <span data-ttu-id="bd764-134">AUTO_UPDATE_STATISTICS (Option)</span><span class="sxs-lookup"><span data-stu-id="bd764-134">AUTO_UPDATE_STATISTICS Option</span></span>  
 <span data-ttu-id="bd764-135">Wenn die AUTO_UPDATE_STATISTICS-Option zur automatischen Aktualisierung von Statistiken aktiviert ist, stellt der Abfrageoptimierer fest, wann Statistiken veraltet sein könnten, und aktualisiert diese Statistiken, sobald sie von einer Abfrage verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-135">When the automatic update statistics option, AUTO_UPDATE_STATISTICS, is on, the query optimizer determines when statistics might be out-of-date and then updates them when they are used by a query.</span></span> <span data-ttu-id="bd764-136">Statistiken sind veraltet, wenn die Datenverteilung in der Tabelle oder indizierten Sicht durch die Vorgänge INSERT, UPDATE, DELETE oder MERGE geändert wurde.</span><span class="sxs-lookup"><span data-stu-id="bd764-136">Statistics become out-of-date after insert, update, delete, or merge operations change the data distribution in the table or indexed view.</span></span> <span data-ttu-id="bd764-137">Der Abfrageoptimierer stellt fest, wann Statistiken veraltet sein könnten, indem er die Anzahl der Datenänderungen seit des letzten Statistikupdates ermittelt und sie mit einem Schwellenwert vergleicht.</span><span class="sxs-lookup"><span data-stu-id="bd764-137">The query optimizer determines when statistics might be out-of-date by counting the number of data modifications since the last statistics update and comparing the number of modifications to a threshold.</span></span> <span data-ttu-id="bd764-138">Der Schwellenwert basiert auf der Anzahl von Zeilen in der Tabelle oder indizierten Sicht.</span><span class="sxs-lookup"><span data-stu-id="bd764-138">The threshold is based on the number of rows in the table or indexed view.</span></span>  
  
 <span data-ttu-id="bd764-139">Bevor der Abfrageoptimierer eine Abfrage kompiliert und einen zwischengespeicherten Abfrageplan ausführt, sucht er nach veralteten Statistiken.</span><span class="sxs-lookup"><span data-stu-id="bd764-139">The query optimizer checks for out-of-date statistics before compiling a query and before executing a cached query plan.</span></span> <span data-ttu-id="bd764-140">Vor dem Kompilieren einer Abfrage ermittelt der Abfrageoptimierer anhand der Spalten, Tabellen und indizierten Sichten im Abfrageprädikat, welche Statistiken veraltet sein könnten.</span><span class="sxs-lookup"><span data-stu-id="bd764-140">Before compiling a query, the query optimizer uses the columns, tables, and indexed views in the query predicate to determine which statistics might be out-of-date.</span></span> <span data-ttu-id="bd764-141">Vor dem Ausführen eines zwischengespeicherten Abfrageplans überprüft das [!INCLUDE[ssDE](../../../includes/ssde-md.md)] , ob der Abfrageplan auf aktuelle Statistiken verweist.</span><span class="sxs-lookup"><span data-stu-id="bd764-141">Before executing a cached query plan, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifies that the query plan references up-to-date statistics.</span></span>  
  
 <span data-ttu-id="bd764-142">Die AUTO_UPDATE_STATISTICS-Option gilt für Statistikobjekte, die für Indizes, einzelne Spalten in Abfrageprädikaten und mit der [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) -Anweisung generierte Statistiken erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-142">The AUTO_UPDATE_STATISTICS option applies to statistics objects created for indexes, single-columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="bd764-143">Diese Option gilt auch für gefilterte Statistiken.</span><span class="sxs-lookup"><span data-stu-id="bd764-143">This option also applies to filtered statistics.</span></span>  
  
 <span data-ttu-id="bd764-144">AUTO_UPDATE_STATISTICS_ASYNC</span><span class="sxs-lookup"><span data-stu-id="bd764-144">AUTO_UPDATE_STATISTICS_ASYNC</span></span>  
 <span data-ttu-id="bd764-145">Mit der AUTO_UPDATE_STATISTICS_ASYNC-Option für die asynchrone Statistikaktualisierung wird festgelegt, ob der Abfrageoptimierer die synchrone oder asynchrone Statistikaktualisierung verwendet.</span><span class="sxs-lookup"><span data-stu-id="bd764-145">The asynchronous statistics update option, AUTO_UPDATE_STATISTICS_ASYNC, determines whether the query optimizer uses synchronous or asynchronous statistics updates.</span></span> <span data-ttu-id="bd764-146">Die Option für das asynchrone Statistikupdate ist standardmäßig deaktiviert, sodass der Abfrageoptimierer Statistiken synchron aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="bd764-146">By default, the asynchronous statistics update option is off, and the query optimizer updates statistics synchronously.</span></span> <span data-ttu-id="bd764-147">Die AUTO_UPDATE_STATISTICS_ASYNC-Option gilt für Statistikobjekte, die für Indizes, einzelne Spalten in Abfrageprädikaten und mit der [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) -Anweisung generierte Statistiken erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-147">The AUTO_UPDATE_STATISTICS_ASYNC option applies to statistics objects created for indexes, single columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span>  
  
 <span data-ttu-id="bd764-148">Statistikaktualisierungen können entweder synchron (Standard) oder asynchron sein.</span><span class="sxs-lookup"><span data-stu-id="bd764-148">Statistics updates can be either synchronous (the default) or asynchronous.</span></span> <span data-ttu-id="bd764-149">Bei synchronen Statistikupdates werden Abfragen immer anhand aktueller Statistiken kompiliert und ausgeführt. Wenn Statistiken veraltet sind, wartet der Abfrageoptimierer auf aktualisierte Statistiken, bevor er die Abfrage kompiliert und ausführt.</span><span class="sxs-lookup"><span data-stu-id="bd764-149">With synchronous statistics updates, queries always compile and execute with up-to-date statistics; When statistics are out-of-date, the query optimizer waits for updated statistics before compiling and executing the query.</span></span> <span data-ttu-id="bd764-150">Bei asynchronen Statistikupdates werden Abfragen anhand vorhandener Statistiken kompiliert, auch wenn diese veraltet sind. Der Abfrageoptimierer könnte einen suboptimalen Abfrageplan auswählen, wenn die Statistiken beim Kompilieren der Abfrage veraltet sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-150">With asynchronous statistics updates, queries compile with existing statistics even if the existing statistics are out-of-date; The query optimizer could choose a suboptimal query plan if statistics are out-of-date when the query compiles.</span></span> <span data-ttu-id="bd764-151">Wenn Abfragen nach dem Ausführen asynchroner Updates kompiliert werden, hat dies den Vorteil, dass für die Abfragen aktualisierte Statistiken verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-151">Queries that compile after the asynchronous updates have completed will benefit from using the updated statistics.</span></span>  
  
 <span data-ttu-id="bd764-152">Verwenden Sie ggf. synchrone Statistiken, wenn Sie Vorgänge ausführen, die die Verteilung der Daten ändern, beispielsweise das Kürzen einer Tabelle oder das Ausführen eines Massenupdates für einen großen Zeilenprozentsatz.</span><span class="sxs-lookup"><span data-stu-id="bd764-152">Consider using synchronous statistics when you perform operations that change the distribution of data, such as truncating a table or performing a bulk update of a large percentage of the rows.</span></span> <span data-ttu-id="bd764-153">Wenn Sie nach dem Abschließen des Vorgangs die Statistiken nicht aktualisieren, wird mithilfe von synchronen Statistiken sichergestellt, dass Statistiken vor dem Ausführen von Abfragen über die geänderten Daten aktuell sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-153">If you do not update the statistics after completing the operation, using synchronous statistics will ensure statistics are up-to-date before executing queries on the changed data.</span></span>  
  
 <span data-ttu-id="bd764-154">In den folgenden Szenarien empfiehlt sich die Verwendung asynchroner Statistiken, um besser vorhersagbare Antwortzeiten für Abfragen zu erzielen:</span><span class="sxs-lookup"><span data-stu-id="bd764-154">Consider using asynchronous statistics to achieve more predictable query response times for the following scenarios:</span></span>  
  
-   <span data-ttu-id="bd764-155">Häufig werden von der Anwendung die gleichen Abfragen, ähnliche Abfragen bzw. ähnliche zwischengespeicherte Abfragepläne ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="bd764-155">Your application frequently executes the same query, similar queries, or similar cached query plans.</span></span> <span data-ttu-id="bd764-156">Bei Verwendung asynchroner Statistikupdates können die Antwortzeiten für Abfragen vorhersagbarer sein als bei synchronen Statistikupdates, weil der Abfrageoptimierer eingehende Abfragen direkt ausführen kann, ohne auf aktuelle Statistiken zu warten.</span><span class="sxs-lookup"><span data-stu-id="bd764-156">Your query response times might be more predictable with asynchronous statistics updates than with synchronous statistics updates because the query optimizer can execute incoming queries without waiting for up-to-date statistics.</span></span> <span data-ttu-id="bd764-157">Dadurch wird verhindert, dass sich einige Abfragen verzögern und andere nicht.</span><span class="sxs-lookup"><span data-stu-id="bd764-157">This avoids delaying some queries and not others.</span></span>  
  
-   <span data-ttu-id="bd764-158">In der Anwendung sind Timeouts bei Clientanforderungen aufgetreten, die dadurch verursacht werden, dass mindestens eine Abfrage auf aktualisierte Statistiken wartet.</span><span class="sxs-lookup"><span data-stu-id="bd764-158">Your application has experienced client request time outs caused by one or more queries waiting for updated statistics.</span></span> <span data-ttu-id="bd764-159">In einigen Fällen kann das Warten auf synchrone Statistiken dazu führen, dass Anwendungen mit kurzen Timeouts einen Fehler erzeugen.</span><span class="sxs-lookup"><span data-stu-id="bd764-159">In some cases, waiting for synchronous statistics could cause applications with aggressive time outs to fail.</span></span>  
  
 <span data-ttu-id="bd764-160">INCREMENTAL STATS</span><span class="sxs-lookup"><span data-stu-id="bd764-160">INCREMENTAL STATS</span></span>  
 <span data-ttu-id="bd764-161">Bei ON wird die Statistik pro Partition erstellt.</span><span class="sxs-lookup"><span data-stu-id="bd764-161">When ON, the statistics created are per partition statistics.</span></span> <span data-ttu-id="bd764-162">Bei OFF wird die Statistikstruktur gelöscht und die Statistik von [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] neu berechnet.</span><span class="sxs-lookup"><span data-stu-id="bd764-162">When OFF, the statistics tree is dropped and [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] re-computes the statistics.</span></span> <span data-ttu-id="bd764-163">Der Standardwert ist OFF.</span><span class="sxs-lookup"><span data-stu-id="bd764-163">The default is OFF.</span></span> <span data-ttu-id="bd764-164">Diese Einstellung überschreibt die INCREMENTAL-Eigenschaft auf Datenbankebene.</span><span class="sxs-lookup"><span data-stu-id="bd764-164">This setting overrides the database level INCREMENTAL property.</span></span>  
  
 <span data-ttu-id="bd764-165">Wenn einer umfangreichen Tabelle neue Partitionen hinzugefügt werden, sollte die Statistik aktualisiert werden, um die neuen Partitionen zu berücksichtigen.</span><span class="sxs-lookup"><span data-stu-id="bd764-165">When new partitions are added to a large table, statistics should be updated to include the new partitions.</span></span> <span data-ttu-id="bd764-166">Das Scannen der gesamten Tabelle (FULLSCAN- oder SAMPLE-Option) könnte jedoch ziemlich lange dauern.</span><span class="sxs-lookup"><span data-stu-id="bd764-166">However the time required to scan the entire table (FULLSCAN or SAMPLE option) might be quite long.</span></span> <span data-ttu-id="bd764-167">Außerdem ist das Scannen der gesamten Tabelle nicht erforderlich, da ggf. nur die Statistik der neuen Partitionen benötigt wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-167">Also, scanning the entire table isn't necessary because only the statistics on the new partitions might be needed.</span></span> <span data-ttu-id="bd764-168">Durch die INCREMENTAL-Option werden nur Statistikdaten pro Partition erstellt und gespeichert. Beim Update werden nur die Statistiken der Partitionen aktualisiert, die eine neue Statistik erfordern.</span><span class="sxs-lookup"><span data-stu-id="bd764-168">The incremental option creates and stores statistics on a per partition basis, and when updated, only refreshes statistics on those partitions that need new statistics</span></span>  
  
 <span data-ttu-id="bd764-169">Wenn Statistiken pro Partition nicht unterstützt werden, wird die Option ignoriert und eine Warnung generiert.</span><span class="sxs-lookup"><span data-stu-id="bd764-169">If per partition statistics are not supported the option is ignored and a warning is generated.</span></span> <span data-ttu-id="bd764-170">Inkrementelle Statistiken werden für folgende Statistiktypen nicht unterstützt:</span><span class="sxs-lookup"><span data-stu-id="bd764-170">Incremental stats are not supported for following statistics types:</span></span>  
  
-   <span data-ttu-id="bd764-171">Statistiken, die mit Indizes erstellt wurden, die über keine Partitionsausrichtung mit der Basistabelle verfügen.</span><span class="sxs-lookup"><span data-stu-id="bd764-171">Statistics created with indexes that are not partition-aligned with the base table.</span></span>  
  
-   <span data-ttu-id="bd764-172">Statistiken, die mit lesbaren sekundären AlwaysOn-Datenbanken erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-172">Statistics created on AlwaysOn readable secondary databases.</span></span>  
  
-   <span data-ttu-id="bd764-173">Statistiken, die für schreibgeschützte Datenbanken erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-173">Statistics created on read-only databases.</span></span>  
  
-   <span data-ttu-id="bd764-174">Statistiken, die für gefilterte Indizes erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-174">Statistics created on filtered indexes.</span></span>  
  
-   <span data-ttu-id="bd764-175">Statistiken, die für Sichten erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-175">Statistics created on views.</span></span>  
  
-   <span data-ttu-id="bd764-176">Statistiken, die für interne Tabellen erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-176">Statistics created on internal tables.</span></span>  
  
-   <span data-ttu-id="bd764-177">Statistiken, die mit räumlichen Indizes oder XML-Indizes erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-177">Statistics created with spatial indexes or XML indexes.</span></span>  
  
||  
|-|  
|<span data-ttu-id="bd764-178">**Gilt für**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] bis [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="bd764-178">**Applies to**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] through [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>|  
  
##  <a name="when-to-create-statistics"></a><a name="CreateStatistics"></a><span data-ttu-id="bd764-179">Zeitpunkt der Erstellung von Statistiken</span><span class="sxs-lookup"><span data-stu-id="bd764-179">When to Create Statistics</span></span>  
 <span data-ttu-id="bd764-180">Der Abfrageoptimierer erstellt automatisch folgende Statistiken:</span><span class="sxs-lookup"><span data-stu-id="bd764-180">The query optimizer already creates statistics in the following ways:</span></span>  
  
1.  <span data-ttu-id="bd764-181">Bei der Indexerstellung berechnet der Abfrageoptimierer Statistiken für Indizes, die sich auf Tabellen oder Sichten beziehen.</span><span class="sxs-lookup"><span data-stu-id="bd764-181">The query optimizer creates statistics for indexes on tables or views when the index is created.</span></span> <span data-ttu-id="bd764-182">Diese Statistiken werden für die Schlüsselspalten des Indexes erstellt.</span><span class="sxs-lookup"><span data-stu-id="bd764-182">These statistics are created on the key columns of the index.</span></span> <span data-ttu-id="bd764-183">Wenn es sich um einen gefilterten Index handelt, erstellt der Abfrageoptimierer gefilterte Statistiken für die gleiche Teilmenge von Zeilen, die für den gefilterten Index angegeben wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-183">If the index is a filtered index, the query optimizer creates filtered statistics on the same subset of rows specified for the filtered index.</span></span> <span data-ttu-id="bd764-184">Weitere Informationen zu gefilterten Indizes finden Sie unter [Erstellen gefilterter Indizes](../indexes/create-filtered-indexes.md) und [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-184">For more information about filtered indexes, see [Create Filtered Indexes](../indexes/create-filtered-indexes.md) and [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span></span>  
  
2.  <span data-ttu-id="bd764-185">Der Abfrageoptimierer erstellt Statistiken für einzelne Spalten in Abfrageprädikaten, wenn AUTO_CREATE_STATISTICS aktiviert ist.</span><span class="sxs-lookup"><span data-stu-id="bd764-185">The query optimizer creates statistics for single columns in query predicates when AUTO_CREATE_STATISTICS is on.</span></span>  
  
 <span data-ttu-id="bd764-186">Bei den meisten Abfragen werden durch diese beiden Methoden zum Erstellen von Statistiken hochwertige Abfragepläne gewährleistet. In einigen Fällen können Sie Abfragepläne verbessern, indem Sie zusätzliche Statistiken mit der [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) -Anweisung erstellen.</span><span class="sxs-lookup"><span data-stu-id="bd764-186">For most queries, these two methods for creating statistics ensure a high-quality query plan; in a few cases, you can improve query plans by creating additional statistics with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="bd764-187">In diesen zusätzlichen Statistiken können Sie statistische Korrelationen aufzeichnen, die vom Abfrageoptimierer beim Erstellen von Statistiken für Indizes oder einzelne Spalten nicht berücksichtigt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-187">These additional statistics can capture statistical correlations that the query optimizer does not account for when it creates statistics for indexes or single columns.</span></span> <span data-ttu-id="bd764-188">Ihre Anwendung kann über zusätzliche statistische Korrelationen in den Tabellendaten verfügen, durch die der Abfrageoptimierer Abfragepläne verbessern kann, wenn sie für die Berechnung von Statistikobjekten zugrunde gelegt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-188">Your application might have additional statistical correlations in the table data that, if calculated into a statistics object, could enable the query optimizer to improve query plans.</span></span> <span data-ttu-id="bd764-189">Der Abfrageplan kann beispielsweise optimiert werden, indem gefilterte Statistiken für eine Teilmenge von Datenzeilen oder Statistiken für mehrere Spalten für Abfrageprädikatsspalten ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-189">For example, filtered statistics on a subset of data rows or multicolumn statistics on query predicate columns might improve the query plan.</span></span>  
  
 <span data-ttu-id="bd764-190">Wenn Statistiken mit der CREATE STATISTICS-Anweisung erstellt werden, empfiehlt es sich, die AUTO_CREATE_STATISTICS-Option aktiviert zu lassen, damit der Abfrageoptimierer weiterhin routinemäßig Statistiken für einzelne Spalten für Abfrageprädikatsspalten erstellt.</span><span class="sxs-lookup"><span data-stu-id="bd764-190">When creating statistics with the CREATE STATISTICS statement, we recommend keeping the AUTO_CREATE_STATISTICS option on so that the query optimizer continues to routinely create single-column statistics for query predicate columns.</span></span> <span data-ttu-id="bd764-191">Weitere Informationen zu Abfrageprädikaten finden Sie unter [Suchbedingung &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-191">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="bd764-192">Wenn eine der folgenden Bedingungen zutrifft, können Sie die Erstellung von Statistiken mit der CREATE STATISTICS-Anweisung in Erwägung ziehen:</span><span class="sxs-lookup"><span data-stu-id="bd764-192">Consider creating statistics with the CREATE STATISTICS statement when any of the following applies:</span></span>  
  
-   <span data-ttu-id="bd764-193">Der [!INCLUDE[ssDE](../../../includes/ssde-md.md)] -Optimierungsratgeber schlägt vor, Statistiken zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="bd764-193">The [!INCLUDE[ssDE](../../../includes/ssde-md.md)] Tuning Advisor suggests creating statistics.</span></span>  
  
-   <span data-ttu-id="bd764-194">Das Abfrageprädikat enthält mehrere korrelierende Spalten, die sich noch nicht im gleichen Index befinden.</span><span class="sxs-lookup"><span data-stu-id="bd764-194">The query predicate contains multiple correlated columns that are not already in the same index.</span></span>  
  
-   <span data-ttu-id="bd764-195">Bei der Abfrageausführung wird aus einer Teilmenge von Daten ausgewählt.</span><span class="sxs-lookup"><span data-stu-id="bd764-195">The query selects from a subset of data.</span></span>  
  
-   <span data-ttu-id="bd764-196">Statistiken für eine Abfrage fehlen.</span><span class="sxs-lookup"><span data-stu-id="bd764-196">The query has missing statistics.</span></span>  
  
### <a name="query-predicate-contains-multiple-correlated-columns"></a><span data-ttu-id="bd764-197">Das Abfrageprädikat enthält mehrere korrelierende Spalten</span><span class="sxs-lookup"><span data-stu-id="bd764-197">Query Predicate Contains Multiple Correlated Columns</span></span>  
 <span data-ttu-id="bd764-198">Wenn ein Abfrageprädikat mehrere Spalten mit spaltenübergreifenden Beziehungen und Abhängigkeiten enthält, könnte der Abfrageplan durch Statistiken für mehrere Spalten optimiert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-198">When a query predicate contains multiple columns that have cross-column relationships and dependencies, statistics on the multiple columns might improve the query plan.</span></span> <span data-ttu-id="bd764-199">Statistiken für mehrere Spalten enthalten spaltenübergreifende Korrelationsstatistiken, so genannte *Dichten*, die in Statistiken für einzelne Spalten nicht verfügbar sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-199">Statistics on multiple columns contain cross-column correlation statistics, called *densities*, that are not available in single-column statistics.</span></span> <span data-ttu-id="bd764-200">Durch Dichten können Kardinalitätsschätzungen verbessert werden, wenn Abfrageergebnisse von Datenbeziehungen zwischen mehreren Spalten abhängig sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-200">Densities can improve cardinality estimates when query results depend on data relationships among multiple columns.</span></span>  
  
 <span data-ttu-id="bd764-201">Wenn sich die Spalten bereits im gleichen Index befinden, ist das Statistikobjekt für mehrere Spalten bereits vorhanden und muss nicht manuell erstellt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-201">If the columns are already in the same index, the multicolumn statistics object already exists and it is not necessary to create it manually.</span></span> <span data-ttu-id="bd764-202">Wenn sich die Spalten noch nicht im gleichen Index befinden, können Sie Statistiken für mehrere Spalten erstellen, indem Sie einen Index für die Spalten anlegen oder die CREATE STATISTICS-Anweisung verwenden.</span><span class="sxs-lookup"><span data-stu-id="bd764-202">If the columns are not already in the same index, you can create multicolumn statistics by creating an index on the columns or by using the CREATE STATISTICS statement.</span></span> <span data-ttu-id="bd764-203">Zur Verwaltung eines Indexes werden mehr Systemressourcen benötigt als zur Verwaltung eines Statistikobjekts.</span><span class="sxs-lookup"><span data-stu-id="bd764-203">It requires more system resources to maintain an index than a statistics object.</span></span> <span data-ttu-id="bd764-204">Wenn die Anwendung keinen Index für mehrere Spalten erfordert, können Sie Systemressourcen sparen, indem Sie das Statistikobjekt erstellen, ohne den Index zu generieren.</span><span class="sxs-lookup"><span data-stu-id="bd764-204">If the application does not require the multicolumn index, you can economize on system resources by creating the statistics object without creating the index.</span></span>  
  
 <span data-ttu-id="bd764-205">Wenn Statistiken für mehrere Spalten erstellt werden, wirkt sich die Reihenfolge der Spalten in der Statistikobjektdefinition darauf aus, wie effektiv die Dichten beim Erstellen von Kardinalitätsschätzungen sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-205">When creating multicolumn statistics, the order of the columns in the statistics object definition affects the effectiveness of densities for making cardinality estimates.</span></span> <span data-ttu-id="bd764-206">Im Statistikobjekt werden Dichten für jedes Präfix von Schlüsselspalten in der Statistikobjektdefinition gespeichert.</span><span class="sxs-lookup"><span data-stu-id="bd764-206">The statistics object stores densities for each prefix of key columns in the statistics object definition.</span></span> <span data-ttu-id="bd764-207">Weitere Informationen zu Dichten finden Sie unter [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-207">For more information about densities, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="bd764-208">Zum Erstellen von Dichten, die für Kardinalitätsschätzungen hilfreich sind, müssen die Spalten im Abfrageprädikat einem der Spaltenpräfixe in der Statistikobjektdefinition entsprechen.</span><span class="sxs-lookup"><span data-stu-id="bd764-208">To create densities that are useful for cardinality estimates, the columns in the query predicate must match one of the prefixes of columns in the statistics object definition.</span></span> <span data-ttu-id="bd764-209">Im Folgenden wird beispielsweise aus den Spalten `LastName`, `MiddleName`und `FirstName`ein Objekt für eine Statistik für mehrere Spalten erstellt.</span><span class="sxs-lookup"><span data-stu-id="bd764-209">For example, the following creates a multicolumn statistics object on the columns `LastName`, `MiddleName`, and `FirstName`.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
IF EXISTS (SELECT name FROM sys.stats  
    WHERE name = 'LastFirst'  
    AND object_ID = OBJECT_ID ('Person.Person'))  
DROP STATISTICS Person.Person.LastFirst;  
GO  
CREATE STATISTICS LastFirst ON Person.Person (LastName, MiddleName, FirstName);  
GO  
```  
  
 <span data-ttu-id="bd764-210">In diesem Beispiel verfügt das Statistikobjekt `LastFirst` über Dichten für die folgenden Spaltenpräfixe: (`LastName`), (`LastName, MiddleName`) und (`LastName, MiddleName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="bd764-210">In this example, the statistics object `LastFirst` has densities for the following column prefixes: (`LastName`), (`LastName, MiddleName`), and (`LastName, MiddleName, FirstName`).</span></span> <span data-ttu-id="bd764-211">Für (`LastName, FirstName`) ist keine Dichte verfügbar.</span><span class="sxs-lookup"><span data-stu-id="bd764-211">The density is not available for (`LastName, FirstName`).</span></span> <span data-ttu-id="bd764-212">Wenn in der Abfrage `LastName` und `FirstName` ohne `MiddleName`verwendet werden, ist die Dichte für Kardinalitätsschätzungen nicht verfügbar.</span><span class="sxs-lookup"><span data-stu-id="bd764-212">If the query uses `LastName` and `FirstName` without using `MiddleName`, the density is not available for cardinality estimates.</span></span>  
  
### <a name="query-selects-from-a-subset-of-data"></a><span data-ttu-id="bd764-213">Bei der Abfrageausführung wird aus einer Teilmenge von Daten ausgewählt</span><span class="sxs-lookup"><span data-stu-id="bd764-213">Query Selects from a Subset of Data</span></span>  
 <span data-ttu-id="bd764-214">Wenn der Abfrageoptimierer Statistiken für einzelne Spalten und Indizes erstellt, berechnet er Statistiken für die Werte sämtlicher Zeilen.</span><span class="sxs-lookup"><span data-stu-id="bd764-214">When the query optimizer creates statistics for single columns and indexes, it creates the statistics for the values in all rows.</span></span> <span data-ttu-id="bd764-215">Wenn bei Abfragen aus einer Teilmenge von Zeilen ausgewählt wird und diese Teilmenge über eine eindeutige Datenverteilung verfügt, können Abfragepläne durch gefilterte Statistiken verbessert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-215">When queries select from a subset of rows, and that subset of rows has a unique data distribution, filtered statistics can improve query plans.</span></span> <span data-ttu-id="bd764-216">Sie können gefilterte Statistiken erstellen, indem Sie die CREATE STATISTICS-Anweisung mit der WHERE-Klausel verwenden, um den Filterprädikatausdruck zu definieren.</span><span class="sxs-lookup"><span data-stu-id="bd764-216">You can create filtered statistics by using the CREATE STATISTICS statement with the WHERE clause to define the filter predicate expression.</span></span>  
  
 <span data-ttu-id="bd764-217">Durch die Verwendung von [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)]beispielsweise gehört jedes Produkt in der Production.Product-Tabelle zu einer von vier Kategorien in der Production.ProductCategory-Tabelle: Fahrräder, Bauteile, Bekleidung und Zubehör.</span><span class="sxs-lookup"><span data-stu-id="bd764-217">For example, using [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], each product in the Production.Product table belongs to one of four categories in the Production.ProductCategory table: Bikes, Components, Clothing, and Accessories.</span></span> <span data-ttu-id="bd764-218">Jede Kategorie verfügt über eine andere Datenverteilung für das Gewicht: Die Gewichte der Fahrräder reichen von 13,77 bis 30,0, die Gewichte der Bauteile reichen von 2,12 bis 1050,00 mit einigen NULL-Werten, die Gewichte der Bekleidung sind alle NULL, und die Gewichte des Zubehörs sind ebenfalls NULL.</span><span class="sxs-lookup"><span data-stu-id="bd764-218">Each of the categories has a different data distribution for weight: bike weights range from 13.77 to 30.0, component weights range from 2.12 to 1050.00 with some NULL values, clothing weights are all NULL, and accessory weights are also NULL.</span></span>  
  
 <span data-ttu-id="bd764-219">Bei den Fahrrädern liefern gefilterte Statistiken dem Abfrageoptimierer zu allen Fahrradgewichten genauere Statistikdaten und können die Abfrageplanqualität im Vergleich zu Tabellenstatistiken oder nicht vorhandenen Statistiken für die Weight-Spalte verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-219">Using Bikes as an example, filtered statistics on all bike weights will provide more accurate statistics to the query optimizer and can improve the query plan quality compared with full-table statistics or nonexistent statistics on the Weight column.</span></span> <span data-ttu-id="bd764-220">Die Spalte mit dem Fahrradgewicht eignet sich besonders für gefilterte Statistiken, jedoch weniger für einen gefilterten Index, wenn nur relativ wenige Suchen nach Gewichtsangaben ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-220">The bike weight column is a good candidate for filtered statistics but not necessarily a good candidate for a filtered index if the number of weight lookups is relatively small.</span></span> <span data-ttu-id="bd764-221">Die Leistungsvorteile, die gefilterte Indizes bei der Suche bieten, können die zusätzlichen Kosten für Wartung und Speicher, die mit der Implementierung eines gefilterten Indexes in der Datenbank verbunden sind, jedoch nicht aufwiegen.</span><span class="sxs-lookup"><span data-stu-id="bd764-221">The performance gain for lookups that a filtered index provides might not outweigh the additional maintenance and storage cost for adding a filtered index to the database.</span></span>  
  
 <span data-ttu-id="bd764-222">Durch die folgende Anweisung wird die gefilterte `BikeWeights` -Statistik für alle Unterkategorien von Fahrrädern erstellt.</span><span class="sxs-lookup"><span data-stu-id="bd764-222">The following statement creates the `BikeWeights` filtered statistics on all of the subcategories for Bikes.</span></span> <span data-ttu-id="bd764-223">Durch den gefilterten Prädikatausdruck werden Fahrräder definiert, indem alle Fahrradunterkategorien mit dem Vergleich `Production.ProductSubcategoryID IN (1,2,3)`aufgelistet werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-223">The filtered predicate expression defines bikes by enumerating all of the bike subcategories with the comparison `Production.ProductSubcategoryID IN (1,2,3)`.</span></span> <span data-ttu-id="bd764-224">Das Prädikat kann den Kategorienamen für Fahrräder nicht verwenden, da er in der Production.ProductCategory-Tabelle gespeichert ist; alle Spalten im Filterausdruck müssen sich in der gleichen Tabelle befinden.</span><span class="sxs-lookup"><span data-stu-id="bd764-224">The predicate cannot use the Bikes category name because it is stored in the Production.ProductCategory table, and all columns in the filter expression must be in the same table.</span></span>  
  
 [!code-sql[StatisticsDDL#FilteredStats2](../../snippets/tsql/SQL14/tsql/statisticsddl/transact-sql/filteredstats.sql#filteredstats2)]  
  
 <span data-ttu-id="bd764-225">Der Abfrageoptimierer kann die gefilterte Statistik für `BikeWeights` verwenden, um den Abfrageplan für die folgende Abfrage zu verbessern, bei der alle Fahrräder ausgewählt werden, deren Gewicht größer ist als `25`.</span><span class="sxs-lookup"><span data-stu-id="bd764-225">The query optimizer can use the `BikeWeights` filtered statistics to improve the query plan for the following query that selects all of the bikes that weigh more than `25`.</span></span>  
  
```  
SELECT P.Weight AS Weight, S.Name AS BikeName  
FROM Production.Product AS P  
    JOIN Production.ProductSubcategory AS S   
    ON P.ProductSubcategoryID = S.ProductSubcategoryID  
WHERE P.ProductSubcategoryID IN (1,2,3) AND P.Weight > 25  
ORDER BY P.Weight;  
GO  
```  
  
### <a name="query-identifies-missing-statistics"></a><span data-ttu-id="bd764-226">Abfrage identifiziert fehlende Statistiken</span><span class="sxs-lookup"><span data-stu-id="bd764-226">Query Identifies Missing Statistics</span></span>  
 <span data-ttu-id="bd764-227">Wenn der Abfrageoptimierer aufgrund eines Fehlers oder eines anderen Ereignisses keine Statistiken erstellen kann, erstellt er den Abfrageplan ohne Verwendung von Statistiken.</span><span class="sxs-lookup"><span data-stu-id="bd764-227">If an error or other event prevents the query optimizer from creating statistics, the query optimizer creates the query plan without using statistics.</span></span> <span data-ttu-id="bd764-228">Der Abfrageoptimierer kennzeichnet die Statistik als nicht vorhanden und versucht beim nächsten Ausführen der Abfrage, die Statistik erneut zu generieren.</span><span class="sxs-lookup"><span data-stu-id="bd764-228">The query optimizer marks the statistics as missing and attempts to regenerate the statistics the next time the query is executed.</span></span>  
  
 <span data-ttu-id="bd764-229">Fehlende Statistiken werden als Warnungen angegeben (Tabellenname als rot formatierter Text), wenn der Ausführungsplan einer Abfrage mithilfe von [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]grafisch angezeigt wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-229">Missing statistics are indicated as warnings (table name in red text) when the execution plan of a query is graphically displayed using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="bd764-230">Das Fehlen von Statistiken wird zudem angezeigt, wenn die **Missing Column Statistics**-Ereignisklasse mithilfe von [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] überwacht wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-230">Additionally, monitoring the **Missing Column Statistics** event class by using [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indicates when statistics are missing.</span></span> <span data-ttu-id="bd764-231">Weitere Informationen finden Sie unter [Fehler und Warnungen-Ereigniskategorie &#40;Datenbank-Engine&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="bd764-231">For more information, see [Errors and Warnings Event Category &#40;Database Engine&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span></span>  
  
 <span data-ttu-id="bd764-232">Wenn Statistiken fehlen, führen Sie die folgenden Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="bd764-232">If statistics are missing, perform the following steps:</span></span>  
  
-   <span data-ttu-id="bd764-233">Überprüfen Sie, ob AUTO_CREATE_STATISTICS und AUTO_UPDATE_STATISTICS aktiviert sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-233">Verify that AUTO_CREATE_STATISTICS and AUTO_UPDATE_STATISTICS are on.</span></span>  
  
-   <span data-ttu-id="bd764-234">Stellen Sie sicher, dass die Datenbank nicht schreibgeschützt ist.</span><span class="sxs-lookup"><span data-stu-id="bd764-234">Verify that the database is not read-only.</span></span> <span data-ttu-id="bd764-235">Wenn die Datenbank schreibgeschützt ist, können vom Abfrageoptimierer keine Statistiken gespeichert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-235">If the database is read-only, the query optimizer cannot save statistics.</span></span>  
  
-   <span data-ttu-id="bd764-236">Erstellen Sie die fehlende Statistik mithilfe der CREATE STATISTICS-Anweisung.</span><span class="sxs-lookup"><span data-stu-id="bd764-236">Create the missing statistics by using the CREATE STATISTICS statement.</span></span>  
  
 <span data-ttu-id="bd764-237">Fehlen Statistiken über eine schreibgeschützte Datenbank oder Momentaufnahme oder sind diese veraltet, erstellt [!INCLUDE[ssDE](../../../includes/ssde-md.md)] temporäre Statistiken in `tempdb` und behält diese bei.</span><span class="sxs-lookup"><span data-stu-id="bd764-237">When statistics on a read-only database or read-only snapshot are missing or stale, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates and maintains temporary statistics in `tempdb`.</span></span> <span data-ttu-id="bd764-238">Wenn das [!INCLUDE[ssDE](../../../includes/ssde-md.md)] temporäre Statistiken erstellt, wird dem Statistiknamen das _readonly_database_statistic-Suffix angefügt, um die temporären Statistiken von den dauerhaften Statistiken zu unterscheiden.</span><span class="sxs-lookup"><span data-stu-id="bd764-238">When the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates temporary statistics, the statistics name is appended with the suffix _readonly_database_statistic to differentiate the temporary statistics from the permanent statistics.</span></span> <span data-ttu-id="bd764-239">Das Suffix „_readonly_database_statistic“ ist für von [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]generierte Statistiken reserviert.</span><span class="sxs-lookup"><span data-stu-id="bd764-239">The suffix _readonly_database_statistic is reserved for statistics generated by [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="bd764-240">Skripts für die temporären Statistiken können erstellt und auf einer Datenbank mit Lese-/Schreibzugriff reproduziert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-240">Scripts for the temporary statistics can be created and reproduced on a read-write database.</span></span> <span data-ttu-id="bd764-241">Bei einer Skripterstellung ändert [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] das Suffix des Statistiknamens von _readonly_database_statistic zu _readonly_database_statistic_scripted.</span><span class="sxs-lookup"><span data-stu-id="bd764-241">When scripted, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] changes the suffix of the statistics name from _readonly_database_statistic to _readonly_database_statistic_scripted.</span></span>  
  
 <span data-ttu-id="bd764-242">Nur [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] kann temporäre Statistiken erstellen und aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="bd764-242">Only [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can create and update temporary statistics.</span></span> <span data-ttu-id="bd764-243">Sie können jedoch temporäre Statistiken löschen und Statistikeigenschaften mit den gleichen Tools überwachen, die Sie für dauerhafte Statistiken verwenden:</span><span class="sxs-lookup"><span data-stu-id="bd764-243">However, you can delete temporary statistics and monitor statistics properties using the same tools that you use for permanent statistics:</span></span>  
  
-   <span data-ttu-id="bd764-244">Löschen Sie temporäre Statistiken mit der Anweisung [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) -Anweisung generierte Statistiken erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="bd764-244">Delete temporary statistics using the [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="bd764-245">Überwachen Sie Statistiken mit den Katalogsichten **sys.stats** und **sys.stats_columns** .</span><span class="sxs-lookup"><span data-stu-id="bd764-245">Monitor statistics using the **sys.stats** and **sys.stats_columns** catalog views.</span></span> <span data-ttu-id="bd764-246">**sys_stats** beinhaltet die Spalte **is_temporary** . Damit wird angegeben, welche Statistiken dauerhaft und welche temporär sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-246">**sys_stats** includes the **is_temporary** column, to indicate which statistics are permanent and which are temporary.</span></span>  
  
 <span data-ttu-id="bd764-247">Da temporäre Statistiken in `tempdb` gespeichert werden, werden durch einen Neustart des [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]-Diensts alle temporären Statistiken entfernt.</span><span class="sxs-lookup"><span data-stu-id="bd764-247">Because temporary statistics are stored in `tempdb`, a restart of the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service causes all temporary statistics to disappear.</span></span>  
  
##  <a name="when-to-update-statistics"></a><a name="UpdateStatistics"></a><span data-ttu-id="bd764-248">Zeitpunkt der Statistik Aktualisierung</span><span class="sxs-lookup"><span data-stu-id="bd764-248">When to Update Statistics</span></span>  
 <span data-ttu-id="bd764-249">Der Abfrageoptimierer stellt fest, wann Statistiken veraltet sein könnten, und aktualisiert sie, sobald sie für einen Abfrageplan benötigt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-249">The query optimizer determines when statistics might be out-of-date and then updates them when they are needed for a query plan.</span></span> <span data-ttu-id="bd764-250">In einigen Fällen können Sie den Abfrageplan und damit die Abfrageleistung verbessern, indem Sie Statistiken häufiger aktualisieren, als dies bei Aktivierung von AUTO_UPDATE_STATISTICS der Fall ist.</span><span class="sxs-lookup"><span data-stu-id="bd764-250">In some cases you can improve the query plan and therefore improve query performance by updating statistics more frequently than occur when AUTO_UPDATE_STATISTICS is on.</span></span> <span data-ttu-id="bd764-251">Sie können Statistiken mit der UPDATE STATISTICS-Anweisung oder der gespeicherten Prozedur sp_updatestats aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="bd764-251">You can update statistics with the UPDATE STATISTICS statement or the stored procedure sp_updatestats.</span></span>  
  
 <span data-ttu-id="bd764-252">Durch das Update von Statistiken wird sichergestellt, dass Abfragen anhand aktueller Statistiken kompiliert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-252">Updating statistics ensures that queries compile with up-to-date statistics.</span></span> <span data-ttu-id="bd764-253">Dies führt jedoch dazu, dass Abfragen neu kompiliert werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-253">However, updating statistics causes queries to recompile.</span></span> <span data-ttu-id="bd764-254">Es empfiehlt sich, Statistiken nicht zu oft zu aktualisieren und die Vorteile optimierter Abfragepläne gegen den Zeitaufwand für die Neukompilierung von Abfragen abzuwägen.</span><span class="sxs-lookup"><span data-stu-id="bd764-254">We recommend not updating statistics too frequently because there is a performance tradeoff between improving query plans and the time it takes to recompile queries.</span></span> <span data-ttu-id="bd764-255">Die Entscheidung hängt von der verwendeten Anwendung ab.</span><span class="sxs-lookup"><span data-stu-id="bd764-255">The specific tradeoffs depend on your application.</span></span>  
  
 <span data-ttu-id="bd764-256">Beim Aktualisieren von Statistiken mit UPDATE STATISTICS oder sp_updatestats empfiehlt es sich, AUTO_UPDATE_STATISTICS aktiviert zu lassen, damit der Abfrageoptimierer die Statistiken weiterhin routinemäßig aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="bd764-256">When updating statistics with UPDATE STATISTICS or sp_updatestats, we recommend keeping AUTO_UPDATE_STATISTICS set to ON so that the query optimizer continues to routinely update statistics.</span></span> <span data-ttu-id="bd764-257">Weitere Informationen zum Aktualisieren von Statistiken für eine Spalte, einen Index, eine Tabelle oder eine indizierte Sicht finden Sie unter [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-257">For more information about how to update statistics on a column, an index, a table, or an indexed view, see [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span></span> <span data-ttu-id="bd764-258">Informationen zum Aktualisieren von Statistiken für alle benutzerdefinierten und internen Tabellen in der Datenbank finden Sie in der Beschreibung der gespeicherten Prozedur [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-258">For information about how to update statistics for all user-defined and internal tables in the database, see the stored procedure [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="bd764-259">Um zu ermitteln, wann Statistiken zuletzt aktualisiert wurden, verwenden Sie die [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) -Funktion.</span><span class="sxs-lookup"><span data-stu-id="bd764-259">To determine when statistics were last updated, use the [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) function.</span></span>  
  
 <span data-ttu-id="bd764-260">Ziehen Sie die Aktualisierung von Statistiken unter folgenden Bedingungen in Betracht:</span><span class="sxs-lookup"><span data-stu-id="bd764-260">Consider updating statistics for the following conditions:</span></span>  
  
-   <span data-ttu-id="bd764-261">Die Ausführungszeiten von Abfragen sind langsam.</span><span class="sxs-lookup"><span data-stu-id="bd764-261">Query execution times are slow.</span></span>  
  
-   <span data-ttu-id="bd764-262">Es werden INSERT-Vorgänge für aufsteigend oder absteigend sortierte Schlüsselspalten ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="bd764-262">Insert operations occur on ascending or descending key columns.</span></span>  
  
-   <span data-ttu-id="bd764-263">Eine Wartung wurde durchgeführt.</span><span class="sxs-lookup"><span data-stu-id="bd764-263">After maintenance operations.</span></span>  
  
### <a name="query-execution-times-are-slow"></a><span data-ttu-id="bd764-264">Die Ausführungszeiten von Abfragen sind langsam</span><span class="sxs-lookup"><span data-stu-id="bd764-264">Query Execution Times Are Slow</span></span>  
 <span data-ttu-id="bd764-265">Wenn die Antwortzeiten von Abfragen langsam oder nicht vorhersagbar sind, sollten Sie sicherstellen, dass Abfragen auf aktuelle Statistiken zugreifen, bevor Sie weitere Schritte zur Problembehandlung ausführen.</span><span class="sxs-lookup"><span data-stu-id="bd764-265">If query response times are slow or unpredictable, ensure that queries have up-to-date statistics before performing additional troubleshooting steps.</span></span>  
  
### <a name="insert-operations-occur-on-ascending-or-descending-key-columns"></a><span data-ttu-id="bd764-266">Es werden INSERT-Vorgänge für aufsteigend oder absteigend sortierte Schlüsselspalten ausgeführt</span><span class="sxs-lookup"><span data-stu-id="bd764-266">Insert Operations Occur on Ascending or Descending Key Columns</span></span>  
 <span data-ttu-id="bd764-267">Statistiken für aufsteigend oder absteigend sortierte Schlüsselspalten, z. B. IDENTITY-Spalten oder Spalten mit Echtzeit-Zeitstempeln, können häufigere Statistikupdates erfordern, als sie vom Abfrageoptimierer ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-267">Statistics on ascending or descending key columns, such as IDENTITY or real-time timestamp columns, might require more frequent statistics updates than the query optimizer performs.</span></span> <span data-ttu-id="bd764-268">Durch INSERT-Vorgänge werden neue Werte an aufsteigend oder absteigend sortierte Spalten angefügt.</span><span class="sxs-lookup"><span data-stu-id="bd764-268">Insert operations append new values to ascending or descending columns.</span></span> <span data-ttu-id="bd764-269">Möglicherweise wurden zu wenige Zeilen hinzugefügt, um ein Statistikupdate auszulösen.</span><span class="sxs-lookup"><span data-stu-id="bd764-269">The number of rows added might be too small to trigger a statistics update.</span></span> <span data-ttu-id="bd764-270">Wenn Statistiken nicht aktuell sind und bei der Abfrageausführung aus den zuletzt hinzugefügten Zeilen ausgewählt wird, weisen die aktuellen Statistiken keine Kardinalitätsschätzungen für diese neuen Werte auf.</span><span class="sxs-lookup"><span data-stu-id="bd764-270">If statistics are not up-to-date and queries select from the most recently added rows, the current statistics will not have cardinality estimates for these new values.</span></span> <span data-ttu-id="bd764-271">Dies kann zu ungenauen Kardinalitätsschätzungen und einer langsamen Abfrageleistung führen.</span><span class="sxs-lookup"><span data-stu-id="bd764-271">This can result in inaccurate cardinality estimates and slow query performance.</span></span>  
  
 <span data-ttu-id="bd764-272">Eine Abfrage, die aus den letzten Bestelldaten auswählt, verfügt z. B. über ungenaue Kardinalitätsschätzungen, wenn die Statistiken nicht aktualisiert werden, um Kardinalitätsschätzungen für die letzten Bestelldaten einzuschließen.</span><span class="sxs-lookup"><span data-stu-id="bd764-272">For example, a query that selects from the most recent sales order dates will have inaccurate cardinality estimates if the statistics are not updated to include cardinality estimates for the most recent sales order dates.</span></span>  
  
### <a name="after-maintenance-operations"></a><span data-ttu-id="bd764-273">Eine Wartung wurde durchgeführt</span><span class="sxs-lookup"><span data-stu-id="bd764-273">After Maintenance Operations</span></span>  
 <span data-ttu-id="bd764-274">Die Aktualisierung von Statistiken empfiehlt sich auch nach dem Durchführen von Wartungsvorgängen, durch die die Verteilung der Daten geändert wird; hierzu gehören z. B. das Abschneiden einer Tabelle oder das Ausführen einer Masseneinfügung für einen großen Prozentsatz von Zeilen.</span><span class="sxs-lookup"><span data-stu-id="bd764-274">Consider updating statistics after performing maintenance procedures that change the distribution of data, such as truncating a table or performing a bulk insert of a large percentage of the rows.</span></span> <span data-ttu-id="bd764-275">Dadurch lassen sich zukünftige Verzögerungen bei der Abfrageverarbeitung vermeiden, d. h., Abfragen müssen nicht auf automatische Statistikupdates warten.</span><span class="sxs-lookup"><span data-stu-id="bd764-275">This can avoid future delays in query processing while queries wait for automatic statistics updates.</span></span>  
  
 <span data-ttu-id="bd764-276">Vorgänge wie das Neuerstellen, Defragmentieren oder Neuorganisieren eines Indexes wirken sich nicht auf die Verteilung von Daten aus.</span><span class="sxs-lookup"><span data-stu-id="bd764-276">Operations such as rebuilding, defragmenting, or reorganizing an index do not change the distribution of data.</span></span> <span data-ttu-id="bd764-277">Folglich müssen Sie keine Statistiken aktualisieren, nachdem Sie die Vorgänge ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG oder ALTER INDEX REORGANIZE ausgeführt haben.</span><span class="sxs-lookup"><span data-stu-id="bd764-277">Therefore, you do not need to update statistics after performing ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG, or ALTER INDEX REORGANIZE operations.</span></span> <span data-ttu-id="bd764-278">Der Abfrageoptimierer aktualisiert Statistiken, wenn mit ALTER INDEX REBUILD oder DBCC DBREINDEX ein Index für eine Tabelle oder Sicht erstellt wird. Dieses Statistikupdate tritt jedoch als Nebenprodukt der Indexneuerstellung auf.</span><span class="sxs-lookup"><span data-stu-id="bd764-278">The query optimizer updates statistics when you rebuild an index on a table or view with ALTER INDEX REBUILD or DBCC DBREINDEX, however; this statistics update is a byproduct of re-creating the index.</span></span> <span data-ttu-id="bd764-279">Der Abfrageoptimierer führt keine Statistikaktualisierung nach einem DBCC INDEXDEFRAG-Vorgang oder ALTER INDEX REORGANIZE-Vorgang aus.</span><span class="sxs-lookup"><span data-stu-id="bd764-279">The query optimizer does not update statistics after DBCC INDEXDEFRAG or ALTER INDEX REORGANIZE operations.</span></span>  
  
##  <a name="queries-that-use-statistics-effectively"></a><a name="DesignStatistics"></a><span data-ttu-id="bd764-280">Abfragen, die Statistiken effektiv verwenden</span><span class="sxs-lookup"><span data-stu-id="bd764-280">Queries That Use Statistics Effectively</span></span>  
 <span data-ttu-id="bd764-281">Bestimmte Abfrageimplementierungen, z. B. lokale Variablen und komplexe Ausdrücke im Abfrageprädikat, können zu suboptimalen Abfrageplänen führen.</span><span class="sxs-lookup"><span data-stu-id="bd764-281">Certain query implementations, such as local variables and complex expressions in the query predicate, can lead to suboptimal query plans.</span></span> <span data-ttu-id="bd764-282">Sie können dies verhindern, indem Sie Abfrageentwurfsrichtlinien für die effektive Verwendung von Statistiken befolgen.</span><span class="sxs-lookup"><span data-stu-id="bd764-282">Following query design guidelines for using statistics effectively can help to avoid this.</span></span> <span data-ttu-id="bd764-283">Weitere Informationen zu Abfrageprädikaten finden Sie unter [Suchbedingung &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="bd764-283">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="bd764-284">Zur Optimierung von Abfrageplänen können Sie Abfrageentwurfsrichtlinien anwenden, die Statistiken effektiv einsetzen, um *Kardinalitätsschätzungen* für Ausdrücke, Variablen und Funktionen in Abfrageprädikaten zu verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-284">You can improve query plans by applying query design guidelines that use statistics effectively to improve *cardinality estimates* for expressions, variables, and functions used in query predicates.</span></span> <span data-ttu-id="bd764-285">Wenn der Abfrageoptimierer den Wert eines Ausdrucks, einer Variablen oder Funktion nicht kennt, weiß er nicht, welchen Wert er im Histogramm suchen soll. Folglich kann nicht die beste Kardinalitätsschätzung aus dem Histogramm abgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-285">When the query optimizer does not know the value of an expression, variable, or function, it does not know which value to lookup in the histogram and therefore cannot retrieve the best cardinality estimate from the histogram.</span></span> <span data-ttu-id="bd764-286">Für alle als Stichprobe entnommenen Zeilen im Histogramm verwendet der Abfrageoptimierer stattdessen die durchschnittliche Anzahl von Zeilen pro eindeutigem Wert als Basis für die Kardinalitätsschätzung.</span><span class="sxs-lookup"><span data-stu-id="bd764-286">Instead, the query optimizer bases the cardinality estimate on the average number of rows per distinct value for all of the sampled rows in the histogram.</span></span> <span data-ttu-id="bd764-287">Dies führt zu suboptimalen Kardinalitätsschätzungen und kann die Abfrageleistung beeinträchtigen.</span><span class="sxs-lookup"><span data-stu-id="bd764-287">This leads to suboptimal cardinality estimates and can hurt query performance.</span></span>  
  
 <span data-ttu-id="bd764-288">In den folgenden Richtlinien wird beschrieben, wie Abfragen geschrieben werden müssen, um Abfragepläne durch optimierte Kardinalitätsschätzungen zu verbessern.</span><span class="sxs-lookup"><span data-stu-id="bd764-288">The following guidelines describe how to write queries to improve query plans by improving cardinality estimates.</span></span>  
  
### <a name="improving-cardinality-estimates-for-expressions"></a><span data-ttu-id="bd764-289">Verbessern von Kardinalitätsschätzungen für Ausdrücke</span><span class="sxs-lookup"><span data-stu-id="bd764-289">Improving Cardinality Estimates for Expressions</span></span>  
 <span data-ttu-id="bd764-290">Um Kardinalitätsschätzungen für Ausdrücke zu verbessern, beachten Sie die folgenden Richtlinien:</span><span class="sxs-lookup"><span data-stu-id="bd764-290">To improve cardinality estimates for expressions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="bd764-291">Vereinfachen Sie nach Möglichkeit Ausdrücke, in denen Konstanten enthalten sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-291">Whenever possible, simplify expressions with constants in them.</span></span> <span data-ttu-id="bd764-292">Der Abfrageoptimierer wertet nicht alle Funktionen und Ausdrücke mit Konstanten aus, bevor er Kardinalitätsschätzungen ermittelt.</span><span class="sxs-lookup"><span data-stu-id="bd764-292">The query optimizer does not evaluate all functions and expressions containing constants prior to determining cardinality estimates.</span></span> <span data-ttu-id="bd764-293">Vereinfachen Sie z. B. den ABS(`-100) to 100`)-Ausdruck.</span><span class="sxs-lookup"><span data-stu-id="bd764-293">For example, simplify the expression ABS(`-100) to 100`.</span></span>  
  
-   <span data-ttu-id="bd764-294">Wenn der Ausdruck mehrere Variablen verwendet, können Sie in Betracht ziehen, eine berechnete Spalte für den Ausdruck und dann Statistiken oder einen Index für die berechnete Spalte zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="bd764-294">If the expression uses multiple variables, consider creating a computed column for the expression and then create statistics or an index on the computed column.</span></span> <span data-ttu-id="bd764-295">Das Abfrageprädikat `WHERE PRICE + Tax > 100` könnte beispielsweise eine bessere Kardinalitätsschätzung aufweisen, wenn Sie eine berechnete Spalte für den Ausdruck `Price + Tax`erstellen.</span><span class="sxs-lookup"><span data-stu-id="bd764-295">For example, the query predicate `WHERE PRICE + Tax > 100` might have a better cardinality estimate if you create a computed column for the expression `Price + Tax`.</span></span>  
  
### <a name="improving-cardinality-estimates-for-variables-and-functions"></a><span data-ttu-id="bd764-296">Verbessern von Kardinalitätsschätzungen für Variablen und Funktionen</span><span class="sxs-lookup"><span data-stu-id="bd764-296">Improving Cardinality Estimates for Variables and Functions</span></span>  
 <span data-ttu-id="bd764-297">Um die Kardinalitätsschätzungen für Variablen und Funktionen zu verbessern, beachten Sie die folgenden Richtlinien:</span><span class="sxs-lookup"><span data-stu-id="bd764-297">To improve the cardinality estimates for variables and functions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="bd764-298">Wenn das Abfrageprädikat eine lokale Variable verwendet, könnte das Umschreiben der Abfrage sinnvoll sein, sodass sie statt einer lokalen Variablen einen Parameter verwendet.</span><span class="sxs-lookup"><span data-stu-id="bd764-298">If the query predicate uses a local variable, consider rewriting the query to use a parameter instead of a local variable.</span></span> <span data-ttu-id="bd764-299">Der Wert einer lokalen Variablen ist nicht bekannt, wenn der Abfrageoptimierer den Abfrageausführungsplan erstellt.</span><span class="sxs-lookup"><span data-stu-id="bd764-299">The value of a local variable is not known when the query optimizer creates the query execution plan.</span></span> <span data-ttu-id="bd764-300">Wenn eine Abfrage auf einem Parameter basiert, verwendet der Abfrageoptimierer die Kardinalitätsschätzung für den ersten tatsächlichen Parameterwert, der an die gespeicherte Prozedur übergeben wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-300">When a query uses a parameter, the query optimizer uses the cardinality estimate for the first actual parameter value that is passed to the stored procedure.</span></span>  
  
-   <span data-ttu-id="bd764-301">Erwägen Sie die Verwendung einer Standardtabelle oder temporären Tabelle, in der die Ergebnisse der Tabellenwertfunktionen mit mehreren Anweisungen enthalten sind.</span><span class="sxs-lookup"><span data-stu-id="bd764-301">Consider using a standard table or temporary table to hold the results of multi-statement table-valued functions.</span></span> <span data-ttu-id="bd764-302">Der Abfrageoptimierer erstellt keine Statistiken für Tabellenwertfunktionen mit mehreren Anweisungen.</span><span class="sxs-lookup"><span data-stu-id="bd764-302">The query optimizer does not create statistics for multi-statement table-valued functions.</span></span> <span data-ttu-id="bd764-303">Bei dieser Vorgehensweise kann der Abfrageoptimierer Statistiken für die Tabellenspalten erstellen und sie zum Optimieren der Abfragepläne nutzen.</span><span class="sxs-lookup"><span data-stu-id="bd764-303">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span>  
  
-   <span data-ttu-id="bd764-304">Standardtabellen oder temporäre Tabelle können auch als Ersatz für Tabellenvariablen verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-304">Consider using a standard table or temporary table as a replacement for table variables.</span></span> <span data-ttu-id="bd764-305">Der Abfrageoptimierer erstellt keine Statistiken für Tabellenvariablen.</span><span class="sxs-lookup"><span data-stu-id="bd764-305">The query optimizer does not create statistics for table variables.</span></span> <span data-ttu-id="bd764-306">Bei dieser Vorgehensweise kann der Abfrageoptimierer Statistiken für die Tabellenspalten erstellen und sie zum Optimieren der Abfragepläne nutzen.</span><span class="sxs-lookup"><span data-stu-id="bd764-306">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span> <span data-ttu-id="bd764-307">Die Vorteile von temporären Tabellen und Tabellenvariablen müssen gegeneinander abgewogen werden. Tabellenvariablen, die in gespeicherten Prozeduren verwendet werden, verursachen weniger Neukompilierungen der gespeicherten Prozedur als temporäre Tabellen.</span><span class="sxs-lookup"><span data-stu-id="bd764-307">There are tradeoffs in determining whether to use a temporary table or a table variable; Table variables used in stored procedures cause fewer recompilations of the stored procedure than temporary tables.</span></span> <span data-ttu-id="bd764-308">Nicht bei allen Anwendungen wird die Leistung optimiert, wenn statt einer Tabellenvariablen eine temporäre Tabelle verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-308">Depending on the application, using a temporary table instead of a table variable might not improve performance.</span></span>  
  
-   <span data-ttu-id="bd764-309">Wenn eine gespeicherte Prozedur eine Abfrage enthält, die einen übergebenen Parameter verwendet, sollten Sie den Parameterwert innerhalb der gespeicherten Prozedur nicht ändern, bevor Sie ihn in der Abfrage verwenden.</span><span class="sxs-lookup"><span data-stu-id="bd764-309">If a stored procedure contains a query that uses a passed-in parameter, avoid changing the parameter value within the stored procedure before using it in the query.</span></span> <span data-ttu-id="bd764-310">Die Kardinalitätsschätzungen für die Abfrage basieren auf dem übergebenen Parameterwert und nicht auf dem aktualisierten Wert.</span><span class="sxs-lookup"><span data-stu-id="bd764-310">The cardinality estimates for the query are based on the passed-in parameter value and not the updated value.</span></span> <span data-ttu-id="bd764-311">Damit der Parameterwert nicht geändert werden kann, können Sie die Abfrage so umschreiben, dass zwei gespeicherte Prozeduren verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="bd764-311">To avoid changing the parameter value, you can rewrite the query to use two stored procedures.</span></span>  
  
     <span data-ttu-id="bd764-312">Durch die gespeicherte Prozedur `Sales.GetRecentSales` wird der Wert des `@date` -Parameters z. B. geändert, wenn `@date is NULL`gilt.</span><span class="sxs-lookup"><span data-stu-id="bd764-312">For example, the following stored procedure `Sales.GetRecentSales` changes the value of the parameter `@date` when `@date is NULL`.</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
     <span data-ttu-id="bd764-313">Wenn der erste Aufruf der gespeicherten Prozedur `Sales.GetRecentSales` für den `@date` -Parameter NULL übergibt, kompiliert der Abfrageoptimierer die gespeicherte Prozedur mit der Kardinalitätsschätzung für `@date = NULL` , obwohl das Abfrageprädikat nicht mit `@date = NULL`aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="bd764-313">If the first call to the stored procedure `Sales.GetRecentSales` passes a NULL for the `@date` parameter, the query optimizer will compile the stored procedure with the cardinality estimate for `@date = NULL` even though the query predicate is not called with `@date = NULL`.</span></span> <span data-ttu-id="bd764-314">Diese Kardinalitätsschätzung kann deutlich von der Anzahl der Zeilen im tatsächlichen Abfrageergebnis abweichen.</span><span class="sxs-lookup"><span data-stu-id="bd764-314">This cardinality estimate might be significantly different than the number of rows in the actual query result.</span></span> <span data-ttu-id="bd764-315">Folglich könnte der Abfrageoptimierer einen suboptimalen Abfrageplan auswählen.</span><span class="sxs-lookup"><span data-stu-id="bd764-315">As a result, the query optimizer might choose a suboptimal query plan.</span></span> <span data-ttu-id="bd764-316">Um dies zu vermeiden, können Sie die gespeicherte Prozedur wie folgt in zwei Prozeduren unterteilen:</span><span class="sxs-lookup"><span data-stu-id="bd764-316">To help avoid this, you can rewrite the stored procedure into two procedures as follows:</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNullRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        EXEC Sales.GetNonNullRecentSales @date;  
    END  
    GO  
    IF OBJECT_ID ( 'Sales.GetNonNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNonNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNonNullRecentSales (@date datetime)  
    AS BEGIN  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
### <a name="improving-cardinality-estimates-with-query-hints"></a><span data-ttu-id="bd764-317">Verbessern von Kardinalitätsschätzungen mit Abfragehinweisen</span><span class="sxs-lookup"><span data-stu-id="bd764-317">Improving Cardinality Estimates with Query Hints</span></span>  
 <span data-ttu-id="bd764-318">Um Kardinalitätsschätzungen für lokale Variablen zu verbessern, können Sie den OPTIMIZE FOR-Abfragehinweis oder den OPTIMIZE FOR UNKNOWN-Abfragehinweis mit RECOMPILE verwenden.</span><span class="sxs-lookup"><span data-stu-id="bd764-318">To improve cardinality estimates for local variables, you can use the OPTIMIZE FOR or OPTIMIZE FOR UNKNOWN query hints with RECOMPILE.</span></span> <span data-ttu-id="bd764-319">Weitere Informationen finden Sie unter [Abfragehinweise &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span><span class="sxs-lookup"><span data-stu-id="bd764-319">For more information, see [Query Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span></span>  
  
 <span data-ttu-id="bd764-320">Bei einigen Anwendungen könnte es zu lange dauern, die Abfrage bei jeder Ausführung neu zu kompilieren.</span><span class="sxs-lookup"><span data-stu-id="bd764-320">For some applications, recompiling the query each time it executes might take too much time.</span></span> <span data-ttu-id="bd764-321">Der OPTIMIZER FOR-Abfragehinweis kann hilfreich sein, auch wenn Sie die RECOMPILE-Option nicht verwenden.</span><span class="sxs-lookup"><span data-stu-id="bd764-321">The OPTIMIZER FOR query hint can help even if you don't use the RECOMPILE option.</span></span> <span data-ttu-id="bd764-322">Sie können der gespeicherten Sales.GetRecentSales-Prozedur z. B. eine OPTIMIZER FOR-Option hinzufügen, um ein bestimmtes Datum anzugeben.</span><span class="sxs-lookup"><span data-stu-id="bd764-322">For example, you could add an OPTIMIZER FOR option to the stored procedure Sales.GetRecentSales to specify a specific date.</span></span> <span data-ttu-id="bd764-323">Im folgenden Beispiel wird der Sales.GetRecentSales-Prozedur die OPTIMIZE FOR-Option hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="bd764-323">The following example adds the OPTIMIZE FOR option to the Sales.GetRecentSales procedure.</span></span>  
  
```sql
USE AdventureWorks2012;  
GO  
IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
    DROP PROCEDURE Sales.GetRecentSales;  
GO  
CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
AS BEGIN  
    IF @date is NULL  
        SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
    SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
    WHERE h.SalesOrderID = d.SalesOrderID  
    AND h.OrderDate > @date  
    OPTION ( OPTIMIZE FOR ( @date = '2004-05-01 00:00:00.000'))  
END;  
GO  
```  
  
### <a name="improving-cardinality-estimates-with-plan-guides"></a><span data-ttu-id="bd764-324">Verbessern von Kardinalitätsschätzungen mit Planhinweislisten</span><span class="sxs-lookup"><span data-stu-id="bd764-324">Improving Cardinality Estimates with Plan Guides</span></span>  
 <span data-ttu-id="bd764-325">Für einige Anwendungen sind die Abfrageentwurfsrichtlinien möglicherweise nicht geeignet, weil Sie die Abfrage nicht ändern können oder die Verwendung des RECOMPILE-Abfragehinweises zu viele Neukompilierungen verursacht.</span><span class="sxs-lookup"><span data-stu-id="bd764-325">For some applications, query design guidelines might not apply because you cannot change the query or using the RECOMPILE query hint might be cause too many recompiles.</span></span> <span data-ttu-id="bd764-326">Sie können mithilfe der Planhinweislisten weitere Hinweise (z. B. USE PLAN) angeben, um das Abfrageverhalten zu steuern. Zur gleichen Zeit können Sie mit dem Hersteller klären, ob die Anwendung geändert wurde.</span><span class="sxs-lookup"><span data-stu-id="bd764-326">You can use plan guides to specify other hints, such as USE PLAN, to control the behavior of the query while investigating application changes with the application vendor.</span></span> <span data-ttu-id="bd764-327">Weitere Informationen zu Planhinweislisten finden Sie unter [Planhinweislisten](../performance/plan-guides.md).</span><span class="sxs-lookup"><span data-stu-id="bd764-327">For more information about plan guides, see [Plan Guides](../performance/plan-guides.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bd764-328">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="bd764-328">See Also</span></span>  
 <span data-ttu-id="bd764-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span></span>  
 <span data-ttu-id="bd764-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span></span>  
 <span data-ttu-id="bd764-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span></span>  
 <span data-ttu-id="bd764-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span></span>  
 <span data-ttu-id="bd764-333">[ALTER DATABASE SET-Optionen &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span><span class="sxs-lookup"><span data-stu-id="bd764-333">[ALTER DATABASE SET Options &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span></span>  
 <span data-ttu-id="bd764-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span></span>  
 <span data-ttu-id="bd764-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span></span>  
 <span data-ttu-id="bd764-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="bd764-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span></span>  
 [<span data-ttu-id="bd764-337">Erstellen gefilterter Indizes</span><span class="sxs-lookup"><span data-stu-id="bd764-337">Create Filtered Indexes</span></span>](../indexes/create-filtered-indexes.md)  
