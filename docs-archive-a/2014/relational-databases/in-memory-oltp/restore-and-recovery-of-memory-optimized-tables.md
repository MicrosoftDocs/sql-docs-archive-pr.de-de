---
title: Wiederherstellen von speicheroptimierten Tabellen | Microsoft-Dokumentation
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 294975b7-e7d1-491b-b66a-fdb1100d2acc
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 5e702798ea68745a038407fb65af7726a5c5d50e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/04/2020
ms.locfileid: "87620373"
---
# <a name="restore-and-recovery-of-memory-optimized-tables"></a><span data-ttu-id="4103c-102">Wiederherstellen von speicheroptimierten Tabellen</span><span class="sxs-lookup"><span data-stu-id="4103c-102">Restore and Recovery of Memory-Optimized Tables</span></span>
  <span data-ttu-id="4103c-103">Der grundlegende Mechanismus zum Wiederherstellen einer Datenbank mit speicheroptimierten Tabellen ist ähnlich wie bei Datenbanken, die nur datenträgerbasierte Tabellen enthalten.</span><span class="sxs-lookup"><span data-stu-id="4103c-103">The basic mechanism to recover or restore a database with memory-optimized tables is similar to databases with only disk-based tables.</span></span> <span data-ttu-id="4103c-104">Anders als datenträgerbasierte Tabellen müssen speicheroptimierte Tabellen jedoch in den Arbeitsspeicher geladen werden, bevor die Benutzer auf die Datenbank zugreifen können.</span><span class="sxs-lookup"><span data-stu-id="4103c-104">But unlike disk-based tables, memory-optimized tables must be loaded into memory before database is available for user access.</span></span> <span data-ttu-id="4103c-105">Hierdurch wird ein neuer Schritt bei der Datenbankwiederherstellung hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="4103c-105">This adds a new step in the database recovery.</span></span> <span data-ttu-id="4103c-106">Die Schritte bei der Datenbankwiederherstellung werden wie folgt geändert:</span><span class="sxs-lookup"><span data-stu-id="4103c-106">The modified steps in database recovery are changed as follows:</span></span>

 <span data-ttu-id="4103c-107">Beim Neustart von [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] durchläuft jede Datenbank eine Wiederherstellungsphase, die aus den folgenden drei Phasen besteht:</span><span class="sxs-lookup"><span data-stu-id="4103c-107">When the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] restarts, each database goes through a recovery phase that consists of the following three phases:</span></span>

1.  <span data-ttu-id="4103c-108">Die Analysephase.</span><span class="sxs-lookup"><span data-stu-id="4103c-108">The analysis phase.</span></span> <span data-ttu-id="4103c-109">Während dieser Phase werden die aktiven Transaktionsprotokolle durchsucht, um Transaktionen mit ausgeführtem Commit und Transaktionen ohne Commit zu erkennen.</span><span class="sxs-lookup"><span data-stu-id="4103c-109">During this phase, a pass is made on the active transaction logs to detect committed and uncommitted transactions.</span></span> <span data-ttu-id="4103c-110">Die In-Memory-OLTP-Engine identifiziert den zu ladenden Prüfpunkt und lädt die Protokolleinträge der Systemtabelle vorab.</span><span class="sxs-lookup"><span data-stu-id="4103c-110">The In-Memory OLTP engine identifies the checkpoint to load and preloads its system table log entries.</span></span> <span data-ttu-id="4103c-111">Außerdem werden einige Protokolldatensätze für die Dateizuordnung verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="4103c-111">It will also process some file allocation log records.</span></span>

2.  <span data-ttu-id="4103c-112">Die Rollforwardphase.</span><span class="sxs-lookup"><span data-stu-id="4103c-112">The redo phase.</span></span> <span data-ttu-id="4103c-113">Diese Phase wird für datenträgerbasierte und speicheroptimierte Tabellen gleichzeitig ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="4103c-113">This phase is run concurrently on both disk-based and memory-optimized tables.</span></span>

     <span data-ttu-id="4103c-114">Bei datenträgerbasierten Tabellen wird die Datenbank auf den aktuellen Stand verschoben, und es werden Sperren abgerufen, die von Transaktionen ohne Commit aktiviert wurden.</span><span class="sxs-lookup"><span data-stu-id="4103c-114">For disk-based tables, the database is moved to the current point in time and acquires locks taken by uncommitted transactions.</span></span>

     <span data-ttu-id="4103c-115">Bei speicheroptimierten Tabellen werden Daten aus den Daten- und Änderungsdateipaaren in den Arbeitsspeicher geladen, und die Daten werden dann mit dem aktiven Transaktionsprotokoll auf Grundlage des letzten permanenten Prüfpunkts aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="4103c-115">For memory-optimized tables, data from the data and delta file pairs are loaded into memory and then update the data with the active transaction log based on the last durable checkpoint.</span></span>

     <span data-ttu-id="4103c-116">Wenn die oben genannten Vorgänge für datenträgerbasierte und speicheroptimierte Tabellen abgeschlossen wurden, kann auf die Datenbank zugegriffen werden.</span><span class="sxs-lookup"><span data-stu-id="4103c-116">When the above operations on disk-based and memory-optimized tables are complete, the database is available for access.</span></span>

3.  <span data-ttu-id="4103c-117">Die Rollbackphase.</span><span class="sxs-lookup"><span data-stu-id="4103c-117">The undo phase.</span></span> <span data-ttu-id="4103c-118">In dieser Phase wird für die Transaktionen ohne Commit ein Rollback ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="4103c-118">In this phase, the uncommitted transactions are rolled back.</span></span>

 <span data-ttu-id="4103c-119">Das Laden von speicheroptimierten Tabellen in den Arbeitsspeicher kann die Leistung des Wiederherstellungszeitziels (Recovery Time Objective, RTO) beeinträchtigen.</span><span class="sxs-lookup"><span data-stu-id="4103c-119">Loading memory-optimized tables into memory can affect performance of the recovery time objective (RTO).</span></span> <span data-ttu-id="4103c-120">Um die Ladezeit von speicheroptimierten Daten aus Daten- und Änderungsdateien zu verbessern, lädt die In-Memory-OLTP-Engine die Daten-/Änderungsdateien wie folgt parallel:</span><span class="sxs-lookup"><span data-stu-id="4103c-120">To improve the load time of memory-optimized data from data and delta files, the In-Memory OLTP engine loads the data/delta files in parallel as follows:</span></span>

-   <span data-ttu-id="4103c-121">Erstellen eines Änderungszuordnungsfilters.</span><span class="sxs-lookup"><span data-stu-id="4103c-121">Creating a Delta Map Filter.</span></span> <span data-ttu-id="4103c-122">In Änderungsdateien werden Verweise auf die gelöschten Zeilen gespeichert.</span><span class="sxs-lookup"><span data-stu-id="4103c-122">Delta files store references to the deleted rows.</span></span> <span data-ttu-id="4103c-123">Ein Thread pro Container liest die Änderungsdateien und erstellt einen Änderungszuordnungsfilter.</span><span class="sxs-lookup"><span data-stu-id="4103c-123">One thread per container reads the delta files and creates a delta map filter.</span></span> <span data-ttu-id="4103c-124">(Eine speicheroptimierte Datendateigruppe kann mehrere Container enthalten.)</span><span class="sxs-lookup"><span data-stu-id="4103c-124">(A memory optimized data filegroup can have one or more containers.)</span></span>

-   <span data-ttu-id="4103c-125">Streaming der Datendateien.</span><span class="sxs-lookup"><span data-stu-id="4103c-125">Streaming the data files.</span></span>  <span data-ttu-id="4103c-126">Sobald der Änderungszuordnungsfilter erstellt wurde, werden Datendateien mit so vielen Threads gelesen wie logische CPUs vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="4103c-126">Once the delta-map filter is created, data files are read using as many threads as there are logical CPUs.</span></span> <span data-ttu-id="4103c-127">Jeder Thread, der die Datendatei liest, liest die Datenzeilen, überprüft die zugeordnete Änderungszuordnung und fügt die Zeile nur dann in der Tabelle ein, wenn diese Zeile nicht als gelöscht markiert wurde.</span><span class="sxs-lookup"><span data-stu-id="4103c-127">Each thread reading the data file reads the data rows, checks the associated delta map and only inserts the row into table if this row has not been marked deleted.</span></span> <span data-ttu-id="4103c-128">Dieser Teil der Wiederherstellung kann in einigen Fällen CPU-gebunden sein, wie unten aufgeführt.</span><span class="sxs-lookup"><span data-stu-id="4103c-128">This part of recovery can be CPU bound in some cases as noted below.</span></span>

 <span data-ttu-id="4103c-129">![Speicher optimierte Tabellen.](../../database-engine/media/memory-optimized-tables.gif "Speicheroptimierte Tabellen")</span><span class="sxs-lookup"><span data-stu-id="4103c-129">![Memory-optimized tables.](../../database-engine/media/memory-optimized-tables.gif "Memory-optimized tables.")</span></span>

 <span data-ttu-id="4103c-130">Speicheroptimierte Tabellen können generell mit der Geschwindigkeit des E/A-Vorgangs in den Arbeitsspeicher geladen werden, in einigen Situationen dauert das Laden von Datenzeilen in den Arbeitsspeicher jedoch länger.</span><span class="sxs-lookup"><span data-stu-id="4103c-130">Memory-optimized tables can generally be loaded into memory at the speed of I/O but there are cases when loading data rows into memory will be slower.</span></span> <span data-ttu-id="4103c-131">Dies ist insbesondere in folgenden Situationen der Fall:</span><span class="sxs-lookup"><span data-stu-id="4103c-131">Specific cases are:</span></span>

-   <span data-ttu-id="4103c-132">Eine niedrige Bucketanzahl für den Hashindex kann zu übermäßigen Konflikten führen, wodurch das Einfügen von Datenzeilen langsamer erfolgt.</span><span class="sxs-lookup"><span data-stu-id="4103c-132">Low bucket count for hash index can lead to excessive collision causing data row inserts to be slower.</span></span> <span data-ttu-id="4103c-133">Dies führt normalerweise zu einer sehr hohen allgemeinen CPU-Auslastung, insbesondere gegen Ende der Wiederherstellung.</span><span class="sxs-lookup"><span data-stu-id="4103c-133">This generally results in very high CPU utilization throughout, and especially towards the end of recovery.</span></span> <span data-ttu-id="4103c-134">Wenn Sie den Hashindex ordnungsgemäß konfiguriert haben, sollte die Wiederherstellungszeit nicht beeinträchtigt werden.</span><span class="sxs-lookup"><span data-stu-id="4103c-134">If you configured the hash index correctly, it should not impact the recovery time.</span></span>

-   <span data-ttu-id="4103c-135">Große speicheroptimierte Tabellen mit einem oder mehreren nicht gruppierten Indizes. Anders als bei einem Hashindex, bei dem die Bucketanzahl beim Erstellen festgelegt wird, wachsen nicht gruppierte Indizes dynamisch, was zu einer hohe CPU-Auslastung führt.</span><span class="sxs-lookup"><span data-stu-id="4103c-135">Large memory-optimized tables with one or more nonclustered indexes, unlike a hash index whose bucket count is sized at create time, the nonclustered indexes grow dynamically, resulting in high CPU utilization.</span></span>

## <a name="restoring-a-database-with-memory-optimized-tables"></a><span data-ttu-id="4103c-136">Wiederherstellen einer Datenbank mit speicheroptimierten Tabellen</span><span class="sxs-lookup"><span data-stu-id="4103c-136">Restoring a Database with Memory-optimized tables</span></span>
 <span data-ttu-id="4103c-137">Sie wissen, dass Sie über ausreichend Arbeitsspeicher auf dem Server verfügen, um eine Datenbank wiederherzustellen, allerdings muss der von der Datenbank benötigte Arbeitsspeicher als Teil eines vorhandenen Ressourcenpools berücksichtigt werden.</span><span class="sxs-lookup"><span data-stu-id="4103c-137">You know that you have sufficient memory on the server to restore a database, but there's a requirement  that the memory needed by the database is accounted for as part of an existing Resource Pool.</span></span>  <span data-ttu-id="4103c-138">Sie wissen, dass Sie die Bindung an den Ressourcenpool erst erstellen können, wenn die Datenbank vorhanden ist, daher führen Sie RESTORE WITH NORECOVERY aus.</span><span class="sxs-lookup"><span data-stu-id="4103c-138">You know that you cannot create the binding to the resource pool before the database exists, so you perform the restore WITH NORECOVERY.</span></span>  <span data-ttu-id="4103c-139">Dies bewirkt, dass das Datenträgerimage der Datenbank wiederhergestellt und die Datenbank erstellt wird, aber kein In-Memory OLTP-Speicher verbraucht wird, da die Datenbank nicht online geschaltet wird.</span><span class="sxs-lookup"><span data-stu-id="4103c-139">This causes the disk image of the database to be restored and the database to be created, but no In-Memory OLTP memory is consumed because the database is not brought online.</span></span>

 <span data-ttu-id="4103c-140">An diesem Punkt können Sie die Datenbank an den Ressourcenpool binden und dann RESTORE WITH RECOVERY verwenden, um die wiederhergestellte Datenbank online zu schalten.</span><span class="sxs-lookup"><span data-stu-id="4103c-140">At this point, you can create the Resource Pool to Database binding, and then use RESTORE WITH RECOVERY to bring the restored database online.</span></span>  <span data-ttu-id="4103c-141">Da die Bindung vorhanden ist, bevor die Datenbank online geschaltet wird, wird der betreffende In-Memory OLTP-Speicherverbrauch ordnungsgemäß berücksichtigt.</span><span class="sxs-lookup"><span data-stu-id="4103c-141">Since the binding is in place before the database is brought online, its In-Memory OLTP memory consumption is properly accounted for.</span></span> <span data-ttu-id="4103c-142">Dies erfordert nur eine einmalige Wiederherstellung der Datenbank.</span><span class="sxs-lookup"><span data-stu-id="4103c-142">This requires restoring the database only once.</span></span> <span data-ttu-id="4103c-143">Der erste RESTORE-Befehl ist ein Informationsbefehl, der lediglich den Sicherungsheader liest, und der letzte Befehl löst einfach die Wiederherstellung aus, ohne tatsächlich Bits wiederherzustellen.</span><span class="sxs-lookup"><span data-stu-id="4103c-143">The first RESTORE command is an informational command that only reads the backup header, and the last command simply triggers recovery without actually restoring any bits.</span></span>

## <a name="see-also"></a><span data-ttu-id="4103c-144">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="4103c-144">See Also</span></span>
 [<span data-ttu-id="4103c-145">Sichern und Wiederherstellen speicheroptimierter Tabellen</span><span class="sxs-lookup"><span data-stu-id="4103c-145">Backup, Restore, and Recovery of Memory-Optimized Tables</span></span>](memory-optimized-tables.md)


