---
title: 'Tutorial: Signieren von gespeicherten Prozeduren mit einem Zertifikat | Microsoft-Dokumentation'
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- signing stored procedures tutorial [SQL Server]
ms.assetid: a4b0f23b-bdc8-425f-b0b9-e0621894f47e
author: rothja
ms.author: jroth
ms.openlocfilehash: 6fe387c43431436ba5fba5bcab879584ecdad533
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/04/2020
ms.locfileid: "87622507"
---
# <a name="tutorial-signing-stored-procedures-with-a-certificate"></a><span data-ttu-id="4c98d-102">Lernprogramm: Signieren von gespeicherten Prozeduren mit einem Zertifikat</span><span class="sxs-lookup"><span data-stu-id="4c98d-102">Tutorial: Signing Stored Procedures with a Certificate</span></span>
  <span data-ttu-id="4c98d-103">In diesem Lernprogramm wird erläutert, wie gespeicherte Prozeduren mit einem Zertifikat signiert werden können, das von [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]generiert wurde.</span><span class="sxs-lookup"><span data-stu-id="4c98d-103">This tutorial illustrates signing stored procedures using a certificate generated by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4c98d-104">Damit Sie den Code ausführen können, der in diesem Lernprogramm enthalten ist, müssen Sie die Sicherheit für den gemischte Modus konfiguriert und die [!INCLUDE[ssSampleDBobject](../includes/sssampledbobject-md.md)] -Datenbank installiert haben.</span><span class="sxs-lookup"><span data-stu-id="4c98d-104">To run the code in this tutorial you must have both Mixed Mode security configured and the [!INCLUDE[ssSampleDBobject](../includes/sssampledbobject-md.md)] database installed.</span></span> <span data-ttu-id="4c98d-105">Szenario</span><span class="sxs-lookup"><span data-stu-id="4c98d-105">Scenario</span></span>  
  
 <span data-ttu-id="4c98d-106">Das Signieren einer gespeicherten Prozedur mit einem Zertifikat bietet sich an, wenn Berechtigungen für die gespeicherte Prozedur erforderlich sein sollen, Sie einem Benutzer diese Berechtigungen aber nicht explizit erteilen möchten.</span><span class="sxs-lookup"><span data-stu-id="4c98d-106">Signing stored procedures using a certificate is useful when you want to require permissions on the stored procedure but you do not want to explicitly grant a user those rights.</span></span> <span data-ttu-id="4c98d-107">Zwar gibt es für das Ausführen dieser Aufgabe mehrere Möglichkeiten (z. B. können Sie die EXECUTE AS-Anweisung verwenden), das Verwenden eines Zertifikats ermöglicht aber das Verwenden einer Ablaufverfolgung, um die Person ausfindig zu machen, von der die gespeicherte Prozedur ursprünglich aufgerufen wurde.</span><span class="sxs-lookup"><span data-stu-id="4c98d-107">Although you can accomplish this task in other ways, such as using the EXECUTE AS statement, using a certificate allows you to use a trace to find the original caller of the stored procedure.</span></span> <span data-ttu-id="4c98d-108">Auf diese Weise erreichen Sie ein hohes Maß an Überwachung, insbesondere bei der Sicherheit von DDL-Vorgängen (Data Definition Language, Datendefinitionssprache).</span><span class="sxs-lookup"><span data-stu-id="4c98d-108">This provides a high level of auditing, especially during security or Data Definition Language (DDL) operations.</span></span>  
  
 <span data-ttu-id="4c98d-109">Sie können ein Zertifikat in der master-Datenbank erstellen, damit Berechtigungen auf Serverebene möglich sind. Sie können aber auch ein Zertifikat in einer beliebigen Benutzerdatenbank erstellen, damit Berechtigungen auf Datenbankebene möglich sind.</span><span class="sxs-lookup"><span data-stu-id="4c98d-109">You can create a certificate in the master database to allow server-level permissions, or you can create a certificate in any user databases to allow database-level permissions.</span></span> <span data-ttu-id="4c98d-110">In diesem Szenario muss ein Benutzer, der keine Berechtigungen für die Basistabellen hat, auf eine gespeicherte Prozedur in der [!INCLUDE[ssSampleDBobject](../includes/sssampledbobject-md.md)] -Datenbank zugreifen. Außerdem soll in diesem Szenario der Objektzugriffspfad überwacht werden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-110">In this scenario, a user with no rights to base tables must access a stored procedure in the [!INCLUDE[ssSampleDBobject](../includes/sssampledbobject-md.md)] database, and you want to audit the object access trail.</span></span> <span data-ttu-id="4c98d-111">Dazu erstellen Sie ein Server- und ein Datenbank-Benutzerkonto ohne Berechtigungen für die Basisobjekte sowie ein Datenbank-Benutzerkonto, das Berechtigungen für eine Tabelle und eine gespeicherte Prozedur hat. Andere Methoden für Besitzketten werden nicht verwendet.</span><span class="sxs-lookup"><span data-stu-id="4c98d-111">Rather than using other ownership chain methods, you will create a server and database user account with no rights to the base objects, and a database user account with rights to a table and a stored procedure.</span></span> <span data-ttu-id="4c98d-112">Sowohl die gespeicherte Prozedur als auch das zweite Datenbank-Benutzerkonto werden mit einem Zertifikat gesichert.</span><span class="sxs-lookup"><span data-stu-id="4c98d-112">Both the stored procedure and the second database user account will be secured with a certificate.</span></span> <span data-ttu-id="4c98d-113">Das zweite Datenbank-Benutzerkonto hat Zugriff auf alle Objekte und erteilt dem ersten Datenbank-Benutzerkonto die Berechtigung zum Zugreifen auf die gespeicherte Prozedur.</span><span class="sxs-lookup"><span data-stu-id="4c98d-113">The second database account will have access to all objects, and grant access to the stored procedure to the first database user account.</span></span>  
  
 <span data-ttu-id="4c98d-114">In diesem Szenario erstellen Sie zunächst ein Datenbankzertifikat, eine gespeicherte Prozedur und einen Benutzer. Anschließend testen Sie den Prozess durch Ausführen der folgenden Schritte:</span><span class="sxs-lookup"><span data-stu-id="4c98d-114">In this scenario you will first create a database certificate, a stored procedure, and a user, and then you will test the process following these steps:</span></span>  
  
1.  <span data-ttu-id="4c98d-115">Konfigurieren der Umgebung.</span><span class="sxs-lookup"><span data-stu-id="4c98d-115">Configure the environment.</span></span>  
  
2.  <span data-ttu-id="4c98d-116">Erstellen eines Zertifikats.</span><span class="sxs-lookup"><span data-stu-id="4c98d-116">Create a certificate.</span></span>  
  
3.  <span data-ttu-id="4c98d-117">Erstellen einer gespeicherten Prozedur und Signieren der Prozedur mithilfe des Zertifikats.</span><span class="sxs-lookup"><span data-stu-id="4c98d-117">Create and sign a stored procedure using the certificate.</span></span>  
  
4.  <span data-ttu-id="4c98d-118">Erstellen eines Zertifikatkontos mithilfe des Zertifikats.</span><span class="sxs-lookup"><span data-stu-id="4c98d-118">Create a certificate account using the certificate.</span></span>  
  
5.  <span data-ttu-id="4c98d-119">Erteilen der Datenbankberechtigungen für das Zertifikatkonto.</span><span class="sxs-lookup"><span data-stu-id="4c98d-119">Grant the certificate account database rights.</span></span>  
  
6.  <span data-ttu-id="4c98d-120">Anzeigen des Zugriffskontexts.</span><span class="sxs-lookup"><span data-stu-id="4c98d-120">Display the access context.</span></span>  
  
7.  <span data-ttu-id="4c98d-121">Zurücksetzen der Umgebung.</span><span class="sxs-lookup"><span data-stu-id="4c98d-121">Reset the environment.</span></span>  
  
 <span data-ttu-id="4c98d-122">Jeder Codeblock dieses Beispiels wird jeweils sofort erläutert.</span><span class="sxs-lookup"><span data-stu-id="4c98d-122">Each code block in this example is explained in line.</span></span> <span data-ttu-id="4c98d-123">Informationen, wie Sie das vollständige Beispiel kopieren können, finden Sie unter [Vollständiges Beispiel](#CompleteExample) am Ende dieses Lernprogramms.</span><span class="sxs-lookup"><span data-stu-id="4c98d-123">To copy the complete example, see [Complete Example](#CompleteExample) at the end of this tutorial.</span></span>  
  
## <a name="1-configure-the-environment"></a><span data-ttu-id="4c98d-124">1. Konfigurieren der Umgebung</span><span class="sxs-lookup"><span data-stu-id="4c98d-124">1. Configure the Environment</span></span>  
 <span data-ttu-id="4c98d-125">Zum Festlegen des Anfangskontexts für das Beispiel öffnen Sie in [!INCLUDE[ssManStudioFull](../includes/ssmanstudiofull-md.md)] eine neue Abfrage und führen den folgenden Code aus, um die [!INCLUDE[ssSampleDBobject](../includes/sssampledbobject-md.md)] -Datenbank zu öffnen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-125">To set the initial context of the example, in [!INCLUDE[ssManStudioFull](../includes/ssmanstudiofull-md.md)] open a new Query and run the following code to open the [!INCLUDE[ssSampleDBobject](../includes/sssampledbobject-md.md)] database.</span></span> <span data-ttu-id="4c98d-126">Dieser Code ändert den Datenbankkontext zu `AdventureWorks2012` und erstellt eine neue Serveranmeldung sowie ein neues Datenbank-Benutzerkonto (`TestCreditRatingUser`), wobei ein Kennwort verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="4c98d-126">This code changes the database context to `AdventureWorks2012` and creates a new server login and database user account (`TestCreditRatingUser`), using a password.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
-- Set up a login for the test user  
CREATE LOGIN TestCreditRatingUser  
   WITH PASSWORD = 'ASDECd2439587y'  
GO  
CREATE USER TestCreditRatingUser  
FOR LOGIN TestCreditRatingUser;  
GO  
```  
  
 <span data-ttu-id="4c98d-127">Weitere Informationen zur CREATE USER-Anweisung finden Sie unter [CREATE USER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-user-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4c98d-127">For more information on the CREATE USER statement, see [CREATE USER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-user-transact-sql).</span></span> <span data-ttu-id="4c98d-128">Weitere Informationen zur CREATE LOGIN-Anweisung finden Sie unter [CREATE LOGIN &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-login-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4c98d-128">For more information on the CREATE LOGIN statement, see [CREATE LOGIN &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-login-transact-sql).</span></span>  
  
## <a name="2-create-a-certificate"></a><span data-ttu-id="4c98d-129">2. Erstellen eines Zertifikats</span><span class="sxs-lookup"><span data-stu-id="4c98d-129">2. Create a Certificate</span></span>  
 <span data-ttu-id="4c98d-130">Zertifikate können Sie auf dem Server erstellen, indem Sie die master-Datenbank, eine Benutzerdatenbank oder beide als Kontext verwenden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-130">You can create certificates in the server using the master database as the context, using a user database, or both.</span></span> <span data-ttu-id="4c98d-131">Für das Sichern eines Zertifikats gibt es mehrere Optionen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-131">There are multiple options for securing the certificate.</span></span> <span data-ttu-id="4c98d-132">Weitere Informationen zum Erstellen eines Zertifikats finden Sie unter [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4c98d-132">For more information on certificates, see [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
 <span data-ttu-id="4c98d-133">Führen Sie den folgenden Code aus, um ein Datenbankzertifikat zu erstellen und mit einem Kennwort zu sichern.</span><span class="sxs-lookup"><span data-stu-id="4c98d-133">Run this code to create a database certificate and secure it using a password.</span></span>  
  
```  
CREATE CERTIFICATE TestCreditRatingCer  
   ENCRYPTION BY PASSWORD = 'pGFD4bb925DGvbd2439587y'  
      WITH SUBJECT = 'Credit Rating Records Access',   
      EXPIRY_DATE = '12/05/2014';  
GO  
```  
  
## <a name="3-create-and-sign-a-stored-procedure-using-the-certificate"></a><span data-ttu-id="4c98d-134">3. Erstellen einer gespeicherten Prozedur und Signieren der Prozedur mithilfe des Zertifikats</span><span class="sxs-lookup"><span data-stu-id="4c98d-134">3. Create and Sign a Stored Procedure Using the Certificate</span></span>  
 <span data-ttu-id="4c98d-135">Erstellen Sie mit dem folgenden Code eine gespeicherte Prozedur, die Daten aus der `Vendor` -Tabelle `Purchasing` -Datenbankschema auswählt, wobei der Zugriff auf Unternehmen beschränkt wird, die die Bonität (CreditRating) 1 haben.</span><span class="sxs-lookup"><span data-stu-id="4c98d-135">Use the following code to create a stored procedure that selects data from the `Vendor` table in the `Purchasing` database schema, restricting access to only the companies with a credit rating of 1.</span></span> <span data-ttu-id="4c98d-136">Der erste Abschnitt der gespeicherten Prozedur zeigt den Kontext des Benutzerkontos an, unter dem die gespeicherte Prozedur ausgeführt wird. Hiermit sollen lediglich die Konzepte verdeutlicht werden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-136">Note that the first section of the stored procedure displays the context of the user account running the stored procedure, which is to demonstrate the concepts only.</span></span> <span data-ttu-id="4c98d-137">Es ist nicht erforderlich, die Anforderungen zu erfüllen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-137">It is not required to satisfy the requirements.</span></span>  
  
```  
CREATE PROCEDURE TestCreditRatingSP  
AS  
BEGIN  
   -- Show who is running the stored procedure  
   SELECT SYSTEM_USER 'system Login'  
   , USER AS 'Database Login'  
   , NAME AS 'Context'  
   , TYPE  
   , USAGE   
   FROM sys.user_token     
  
   -- Now get the data  
   SELECT AccountNumber, Name, CreditRating   
   FROM Purchasing.Vendor  
   WHERE CreditRating = 1  
END  
GO  
```  
  
 <span data-ttu-id="4c98d-138">Führen Sie den folgenden Code aus, um die gespeicherte Prozedur mit dem Datenbankzertifikat zu signieren und dazu ein Kennwort zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-138">Run this code to sign the stored procedure with the database certificate, using a password.</span></span>  
  
```  
ADD SIGNATURE TO TestCreditRatingSP   
   BY CERTIFICATE TestCreditRatingCer  
    WITH PASSWORD = 'pGFD4bb925DGvbd2439587y';  
GO  
```  
  
 <span data-ttu-id="4c98d-139">Weitere Informationen zum Aufrufen von gespeicherten Prozeduren finden Sie unter [Gespeicherte Prozeduren &#40;Datenbank-Engine&#41;](stored-procedures/stored-procedures-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="4c98d-139">For more information on stored procedures, see [Stored Procedures &#40;Database Engine&#41;](stored-procedures/stored-procedures-database-engine.md).</span></span>  
  
 <span data-ttu-id="4c98d-140">Weitere Informationen zum Signieren von gespeicherten Prozeduren finden Sie unter [ADD SIGNATURE &#40;Transact-SQL&#41;](/sql/t-sql/statements/add-signature-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4c98d-140">For more information on signing stored procedures, see [ADD SIGNATURE &#40;Transact-SQL&#41;](/sql/t-sql/statements/add-signature-transact-sql).</span></span>  
  
## <a name="4-create-a-certificate-account-using-the-certificate"></a><span data-ttu-id="4c98d-141">4. Erstellen eines Zertifikatkontos mithilfe des Zertifikats</span><span class="sxs-lookup"><span data-stu-id="4c98d-141">4. Create a Certificate Account Using the Certificate</span></span>  
 <span data-ttu-id="4c98d-142">Führen Sie den folgenden Code aus, um über das Zertifikat einen Datenbankbenutzer (`TestCreditRatingcertificateAccount`) zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-142">Run this code to create a database user (`TestCreditRatingcertificateAccount`) from the certificate.</span></span> <span data-ttu-id="4c98d-143">Das Konto hat keine Serveranmeldung und steuert ausschließlich den Zugriff auf die zugrunde liegenden Tabellen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-143">This account has no server login, and will ultimately control access to the underlying tables.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE USER TestCreditRatingcertificateAccount  
   FROM CERTIFICATE TestCreditRatingCer;  
GO  
```  
  
## <a name="5-grant-the-certificate-account-database-rights"></a><span data-ttu-id="4c98d-144">5. Erteilen der Datenbankberechtigungen für das Zertifikatkonto</span><span class="sxs-lookup"><span data-stu-id="4c98d-144">5. Grant the Certificate Account Database Rights</span></span>  
 <span data-ttu-id="4c98d-145">Führen Sie den folgenden Code aus, damit `TestCreditRatingcertificateAccount` die Berechtigungen für die Basistabellen und die gespeicherte Prozedur erteilt werden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-145">Run this code to grant `TestCreditRatingcertificateAccount` rights to the base table and the stored procedure.</span></span>  
  
```  
GRANT SELECT   
   ON Purchasing.Vendor   
   TO TestCreditRatingcertificateAccount;  
GO  
  
GRANT EXECUTE   
   ON TestCreditRatingSP   
   TO TestCreditRatingcertificateAccount;  
GO  
```  
  
 <span data-ttu-id="4c98d-146">Weitere Informationen zum Erteilen von Berechtigungen für Objekte finden Sie unter [GRANT &#40;Transact-SQL&#41;](/sql/t-sql/statements/grant-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4c98d-146">For more information on granting permissions to objects, see [GRANT &#40;Transact-SQL&#41;](/sql/t-sql/statements/grant-transact-sql).</span></span>  
  
## <a name="6-display-the-access-context"></a><span data-ttu-id="4c98d-147">6. Anzeigen des Zugriffskontexts</span><span class="sxs-lookup"><span data-stu-id="4c98d-147">6. Display the Access Context</span></span>  
 <span data-ttu-id="4c98d-148">Damit die Berechtigungen angezeigt werden können, die mit dem Zugriff über die gespeicherte Prozedur verknüpft sind, führen Sie den folgenden Code aus. Der Code erteilt dem Benutzer `TestCreditRatingUser` die Berechtigung, die gespeicherte Prozedur auszuführen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-148">To display the rights associated with the stored procedure access, run the following code to grant the rights to run the stored procedure to the `TestCreditRatingUser` user.</span></span>  
  
```  
GRANT EXECUTE   
   ON TestCreditRatingSP   
   TO TestCreditRatingUser;  
GO  
```  
  
 <span data-ttu-id="4c98d-149">Führen Sie nun den folgenden Code aus, um die gespeicherte Prozedur mit der dbo-Anmeldung auszuführen, die Sie auf dem Server verwendet haben.</span><span class="sxs-lookup"><span data-stu-id="4c98d-149">Next, run the following code to run the stored procedure as the dbo login you used on the server.</span></span> <span data-ttu-id="4c98d-150">Sehen Sie sich die Informationen an, die für den Benutzerkontext ausgegeben wurden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-150">Observe the output of the user context information.</span></span> <span data-ttu-id="4c98d-151">Die Informationen zeigen, dass das Konto dbo der Kontext mit seinen eigenen Berechtigungen ist, die Berechtigungen also nicht über eine Gruppenmitgliedschaft erteilt wurden.</span><span class="sxs-lookup"><span data-stu-id="4c98d-151">It will show the dbo account as the context with its own rights and not through a group membership.</span></span>  
  
```  
EXECUTE TestCreditRatingSP;  
GO  
```  
  
 <span data-ttu-id="4c98d-152">Führen Sie den folgenden Code aus. In dem Code wird die `EXECUTE AS` -Anweisung dazu verwendet, die gespeicherte Prozedur unter dem Konto `TestCreditRatingUser` auszuführen.</span><span class="sxs-lookup"><span data-stu-id="4c98d-152">Run the following code to use the `EXECUTE AS` statement to become the `TestCreditRatingUser` account and run the stored procedure.</span></span> <span data-ttu-id="4c98d-153">Diesmal ist zu sehen, dass der Kontext auf den USER MAPPED TO CERTIFICATE-Kontext (Einem Zertifikat zugeordneter Datenbankbenutzer) festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="4c98d-153">This time you will see the user context is set to the USER MAPPED TO CERTIFICATE context.</span></span>  
  
```  
EXECUTE AS LOGIN = 'TestCreditRatingUser';  
GO  
EXECUTE TestCreditRatingSP;  
GO  
```  
  
 <span data-ttu-id="4c98d-154">Auf diese Weise wird die Überwachung demonstriert, die verfügbar ist, weil Sie die gespeicherte Prozedur signiert haben.</span><span class="sxs-lookup"><span data-stu-id="4c98d-154">This shows you the auditing available because you signed the stored procedure.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4c98d-155">Verwenden Sie EXECUTE AS zum Wechseln des Kontexts in einer Datenbank.</span><span class="sxs-lookup"><span data-stu-id="4c98d-155">Use EXECUTE AS to switch contexts within a database.</span></span>  
  
## <a name="7-reset-the-environment"></a><span data-ttu-id="4c98d-156">7. Zurücksetzen der Umgebung</span><span class="sxs-lookup"><span data-stu-id="4c98d-156">7. Reset the Environment</span></span>  
 <span data-ttu-id="4c98d-157">Im folgenden Code wird die `REVERT`-Anweisung verwendet, um den Kontext des aktuellen Kontos auf dbo zurückzusetzen, und dann die Umgebung zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="4c98d-157">The following code uses the `REVERT` statement to return the context of the current account to dbo, and resets the environment.</span></span>  
  
```  
REVERT;  
GO  
DROP PROCEDURE TestCreditRatingSP;  
GO  
DROP USER TestCreditRatingcertificateAccount;  
GO  
DROP USER TestCreditRatingUser;  
GO  
DROP LOGIN TestCreditRatingUser;  
GO  
DROP CERTIFICATE TestCreditRatingCer;  
GO  
```  
  
 <span data-ttu-id="4c98d-158">Weitere Informationen zur REVERT-Anweisung finden Sie unter [REVERT &#40;Transact-SQL&#41;](/sql/t-sql/statements/revert-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4c98d-158">For more information about the REVERT statement, see [REVERT &#40;Transact-SQL&#41;](/sql/t-sql/statements/revert-transact-sql).</span></span>  
  
##  <a name="complete-example"></a><a name="CompleteExample"></a><span data-ttu-id="4c98d-159">Vervollständigen eines Beispiels</span><span class="sxs-lookup"><span data-stu-id="4c98d-159">Complete Example</span></span>  
 <span data-ttu-id="4c98d-160">In diesem Abschnitt wird der vollständige Beispielcode angezeigt.</span><span class="sxs-lookup"><span data-stu-id="4c98d-160">This section displays the complete example code.</span></span>  
  
```  
/* Step 1 - Open the AdventureWorks2012 database */  
USE AdventureWorks2012;  
GO  
-- Set up a login for the test user  
CREATE LOGIN TestCreditRatingUser  
   WITH PASSWORD = 'ASDECd2439587y'  
GO  
CREATE USER TestCreditRatingUser  
FOR LOGIN TestCreditRatingUser;  
GO  
  
/* Step 2 - Create a certificate in the AdventureWorks2012 database */  
CREATE CERTIFICATE TestCreditRatingCer  
   ENCRYPTION BY PASSWORD = 'pGFD4bb925DGvbd2439587y'  
      WITH SUBJECT = 'Credit Rating Records Access',   
      EXPIRY_DATE = '12/05/2014';  
GO  
  
/* Step 3 - Create a stored procedure and  
sign it using the certificate */  
CREATE PROCEDURE TestCreditRatingSP  
AS  
BEGIN  
   -- Shows who is running the stored procedure  
   SELECT SYSTEM_USER 'system Login'  
   , USER AS 'Database Login'  
   , NAME AS 'Context'  
   , TYPE  
   , USAGE   
   FROM sys.user_token;     
  
   -- Now get the data  
   SELECT AccountNumber, Name, CreditRating   
   FROM Purchasing.Vendor  
   WHERE CreditRating = 1;  
END  
GO  
  
ADD SIGNATURE TO TestCreditRatingSP   
   BY CERTIFICATE TestCreditRatingCer  
    WITH PASSWORD = 'pGFD4bb925DGvbd2439587y';  
GO  
  
/* Step 4 - Create a database user for the certificate.   
This user has the ownership chain associated with it. */  
USE AdventureWorks2012;  
GO  
CREATE USER TestCreditRatingcertificateAccount  
   FROM CERTIFICATE TestCreditRatingCer;  
GO  
  
/* Step 5 - Grant the user database rights */  
GRANT SELECT   
   ON Purchasing.Vendor   
   TO TestCreditRatingcertificateAccount;  
GO  
  
GRANT EXECUTE  
   ON TestCreditRatingSP   
   TO TestCreditRatingcertificateAccount;  
GO  
  
/* Step 6 - Test, using the EXECUTE AS statement */  
GRANT EXECUTE   
   ON TestCreditRatingSP   
   TO TestCreditRatingUser;  
GO  
  
-- Run the procedure as the dbo user, notice the output for the type  
EXEC TestCreditRatingSP;  
GO  
  
EXECUTE AS LOGIN = 'TestCreditRatingUser';  
GO  
EXEC TestCreditRatingSP;  
GO  
  
/* Step 7 - Clean up the example */  
REVERT;  
GO  
DROP PROCEDURE TestCreditRatingSP;  
GO  
DROP USER TestCreditRatingcertificateAccount;  
GO  
DROP USER TestCreditRatingUser;  
GO  
DROP LOGIN TestCreditRatingUser;  
GO  
DROP CERTIFICATE TestCreditRatingCer;  
GO  
```  
  
## <a name="see-also"></a><span data-ttu-id="4c98d-161">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="4c98d-161">See Also</span></span>  
 [<span data-ttu-id="4c98d-162">Sicherheitscenter für SQL Server-Datenbank-Engine und Azure SQL-Datenbank</span><span class="sxs-lookup"><span data-stu-id="4c98d-162">Security Center for SQL Server Database Engine and Azure SQL Database</span></span>](security/security-center-for-sql-server-database-engine-and-azure-sql-database.md)  
  
  
